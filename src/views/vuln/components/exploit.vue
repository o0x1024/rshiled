<template>
  <div class="vuln-exploit-container">
    <a-typography-text style="font-size: large; font-weight: 540;">{{ $t('rhai_plugin.expolit') || 'Rhai Plugin Manager'
      }}</a-typography-text>
    <!-- <a-card class="general-card" :title="$t('vuln.exploit.title')" size="small"> -->
      <a-row :gutter="12" style="margin-top: 12px;">
        <a-col :span="5">
          <a-card class="inner-card">
            <template #title>
              {{ $t('vuln.exploit.pluginList') }}
              <a-tooltip :content="$t('vuln.exploit.pluginListTip')">
                <icon-question-circle style="margin-left: 4px;" />
              </a-tooltip>
            </template>
            <div class="plugin-search">
              <a-input-search
                v-model="searchKeyword"
                :placeholder="$t('vuln.exploit.searchPlaceholder')"
                @search="onSearchSubmit"
                @input="onSearchInput"
                size="small"
              />
            </div>
            <div class="plugin-list">
              <a-spin :loading="loading">
                <a-tree
                  :data="pluginTreeData"
                  v-model:expanded-keys="expandedKeys"
                  :selected-keys="getSelectedPluginId"
                  :auto-expand-parent="true"
                  size="small"
                  @select="handleTreeSelect"
                  @expand="handleTreeExpand"
                  :virtual-list-props="{ height: virtualListHeight }"
                >
                  <template #title="nodeData">
                    <div class="tree-node">
                      <template v-if="nodeData.isLeaf">
                        <div class="plugin-tree-item">
                          <a-tooltip 
                            :content="nodeData.matchReason && searchKeyword 
                              ? `${nodeData.title} (${t(`vuln.search.match.${nodeData.matchReason}`)})`
                              : nodeData.title" 
                            position="right"
                          >
                            <span 
                              class="plugin-name-text" 
                              :class="{'search-match': nodeData.isSearchMatch && searchKeyword}"
                            >
                              {{ nodeData.title }}
                            </span>
                          </a-tooltip>
                          <a-tag v-if="nodeData.severity" :color="getSeverityColor(nodeData.severity)" size="small">
                            {{ getSeverityLabel(nodeData.severity) }}
                          </a-tag>
                        </div>
                      </template>
                      <template v-else>
                        <div class="category-header">
                          <strong :class="{'search-match': nodeData.isSearchMatch && searchKeyword}">
                            {{ nodeData.title }}
                          </strong>
                          <span class="plugin-count">
                            ({{ getPluginCountByType(nodeData.key) }})
                          </span>
                        </div>
                      </template>
                    </div>
                  </template>
                </a-tree>
              </a-spin>
            </div>
          </a-card>
        </a-col>
        <a-col :span="19">
          <a-card v-if="selectedPlugin" class="inner-card compact-card">
            <template #title>
              <div class="card-title-with-tag">
                {{ $t('vuln.exploit.pluginDetail') }}: {{ selectedPlugin.name }}
                <a-tag v-if="selectedPlugin.severity" :color="getSeverityColor(selectedPlugin.severity)" size="small">
                  {{ getSeverityLabel(selectedPlugin.severity) }}
                </a-tag>
              </div>
            </template>
            <div class="plugin-detail">
              <div class="detail-section">
                <a-collapse :default-active-keys="[]" size="small">
                  <a-collapse-item key="1" :header="$t('vuln.exploit.basicInfo')">
                    <a-descriptions :column="4" :data="getPluginBasicInfo()" size="small" />
                  </a-collapse-item>
                </a-collapse>
              </div>
              
              <a-divider style="margin: 8px 0 12px 0" />
              
              <div class="detail-section">
                <h4 class="compact-heading" style="margin-bottom: 12px; display: flex; align-items: center;">
                  <icon-play-circle style="margin-right: 4px;" />
                  {{ $t('vuln.exploit.parameters') }}
                </h4>
                <a-form ref="formRef" :model="formData" layout="vertical" size="small">
                  <!-- 目标参数，所有漏洞利用都需要 -->
                  <a-form-item
                    field="target"
                    :label="$t('vuln.exploit.target')"
                    required
                    style="margin-bottom: 16px;"
                  >
                    <a-input
                      v-model="formData.target"
                      :placeholder="$t('vuln.exploit.targetPlaceholder')"
                    />
                  </a-form-item>
                
                  <!-- 高级选项折叠面板 -->
                  <a-collapse :default-active-keys="[]" style="margin-bottom: 16px;" size="small">
                    <a-collapse-item :header="$t('vuln.exploit.advancedOptions')" key="1">
                      <a-row :gutter="12">
                        <!-- 代理URL参数 -->
                        <a-col :span="12" style="padding-bottom: 8px;">
                          <a-form-item
                            field="proxy_url"
                            :label="$t('vuln.exploit.proxyUrl')"
                          >
                            <a-input
                              v-model="formData.proxy_url"
                              :placeholder="$t('vuln.exploit.proxyUrlPlaceholder')"
                            />
                          </a-form-item>
                        </a-col>
                        
                        <!-- 其他动态参数 -->
                        <template v-for="(param) in selectedPlugin.params.filter(p => p.key !== 'proxy_url')" :key="param.key">
                          <a-col :span="12" style="padding-bottom: 8px;">
                            <a-form-item
                              :field="param.key"
                              :label="param.name"
                              :required="param.required"
                              :extra="param.description"
                            >
                              <a-input
                                v-if="param.type === 'string'"
                                v-model="formData[param.key]"
                                :placeholder="param.description"
                              />
                              <a-input-number
                                v-else-if="param.type === 'number'"
                                v-model="formData[param.key]"
                                :placeholder="param.description"
                              />
                              <a-textarea
                                v-else-if="param.type === 'textarea'"
                                v-model="formData[param.key]"
                                :placeholder="param.description"
                              />
                              <a-switch
                                v-else-if="param.type === 'boolean'"
                                v-model="formData[param.key]"
                              />
                              <a-select
                                v-else-if="param.type === 'select'"
                                v-model="formData[param.key]"
                                :placeholder="param.description"
                              >
                                <a-option
                                  v-for="option in param.options || []"
                                  :key="option.value"
                                  :value="option.value"
                                >
                                  {{ option.label }}
                                </a-option>
                              </a-select>
                              <a-upload
                                v-else-if="param.type === 'file'"
                                :custom-request="(options) => handleFileUpload(options, param.key)"
                                :show-file-list="false"
                              >
                                <a-button size="small">
                                  {{ $t('vuln.exploit.selectFile') }}
                                </a-button>
                                <div v-if="formData[param.key]" style="margin-top: 4px; font-size: 12px;">
                                  {{ getFileName(formData[param.key]) }}
                                </div>
                              </a-upload>
                            </a-form-item>
                          </a-col>
                        </template>
                      </a-row>
                    </a-collapse-item>
                  </a-collapse>
                  
                  <a-form-item style="margin-top: 16px; display: flex; justify-content: flex-end;">
                    <a-button type="primary" @click="handleExploit" :loading="exploiting" size="small" style="min-width: 120px;">
                      <template #icon><icon-play-circle /></template>
                      {{ $t('vuln.exploit.execute') }}
                    </a-button>
                  </a-form-item>
                </a-form>
              </div>
              
              <a-divider v-if="result" margin="8px 0" />
              
              <div v-if="result" class="detail-section">
                <h4 class="compact-heading">{{ $t('vuln.exploit.result') }}</h4>
                
                <!-- HTTP 请求响应展示区 -->
                <div class="http-packet-container">
                  <a-tabs default-active-key="1" type="card-gutter" size="small">
                    <a-tab-pane key="1" :title="$t('vuln.exploit.data')">
                      <div v-if="result && result.data" class="result-section">
                        <a-card class="result-card" :bordered="false" size="small">
                          <template #title>
                            <div class="result-card-title">
                              <icon-check-circle-fill v-if="result.success" class="result-icon success" />
                              <icon-exclamation-circle-fill v-else-if="hasRiskButNotExploitable" class="result-icon warning" />
                              <icon-close-circle-fill v-else class="result-icon info" />
                              <span>{{ 
                                result.success 
                                  ? $t('vuln.exploit.vulnerableFound') 
                                  : (hasRiskButNotExploitable 
                                      ? $t('vuln.exploit.riskFoundNotExploitable') 
                                      : $t('vuln.exploit.notVulnerable'))
                              }}</span>
                            </div>
                          </template>
                          
                          <!-- Main Results -->
                          <div v-if="mainResultData.length > 0" class="result-data">
                            <div v-for="(item, index) in mainResultData" :key="index" 
                              class="data-item" :class="{'risk-item': item.risk}">
                              <a-space direction="vertical">
                                <a-space>
                                  <div class="data-item-label">{{ item.label }}</div>
                                  <div class="data-item-value" :class="{'risk-value': item.risk}">
                                    {{ item.value }}
                                  </div>
                                </a-space>
                              </a-space>
                              <!-- <div class="data-item-label">{{ item.label }}</div>
                              <div class="data-item-value" :class="{'risk-value': item.risk}">
                                {{ item.value }} -->
                              <!-- </div> -->
                            </div>
                          </div>
                          
                          <!-- Additional Information Section -->
                          <div v-if="specialResultData.length > 0" >
                            <a-collapse :default-active-keys="['1']" size="small">
                              <a-collapse-item key="1">
                                <template #header>{{ $t('vuln.exploit.additionalInfo') }}</template>
                                <div v-for="(item, index) in specialResultData" :key="index" 
                                  class="data-item" :class="{'risk-item': item.risk}">

                                  <a-space direction="vertical">
                                    <div class="data-item-label">{{ item.label }}</div>
                                    <div class="data-item-value" :class="{'risk-value': item.risk}">
                                      {{ item.value }}
                                    </div>
                                  </a-space>



                                  <!-- <div class="data-item-label">{{ item.label }}</div>
                                  <div class="data-item-value" :class="{'risk-value': item.risk}">
                                    {{ item.value }}
                                  </div> -->
                                </div>
                              </a-collapse-item>
                            </a-collapse>
                          </div>
                        </a-card>
                      </div>
                      <a-empty v-else :description="$t('vuln.exploit.noData')" />
                    </a-tab-pane>
                    <a-tab-pane key="2" :title="$t('vuln.exploit.details')">
                      <div v-if="result && result.raw_output" class="result-details">
                        <a-card class="result-card" :bordered="false" size="small">
                          <template #title>
                            <div class="result-card-title">
                              <icon-code class="result-icon info" />
                              <span>{{ $t('vuln.exploit.rawOutput') }}</span>
                            </div>
                          </template>
                          <div class="raw-output-wrapper">
                            <pre>{{ result.raw_output }}</pre>
                          </div>
                        </a-card>
                      </div>
                      <a-empty v-else :description="$t('vuln.exploit.noDetails')" />
                    </a-tab-pane>
                    <a-tab-pane key="3" :title="$t('vuln.exploit.httpData')" v-if="result && (result.request || result.response)">
                      <a-card class="result-card" :bordered="false" size="small">
                        <a-tabs type="text" size="small">
                          <template #extra>
                            <a-space size="small">
                              <a-tooltip :content="$t('vuln.exploit.darkMode') || '暗黑模式'">
                                <a-button shape="circle" size="mini" :type="isDarkMode ? 'primary' : 'outline'"
                                  @click="toggleDarkMode">
                                  <icon-moon />
                                </a-button>
                              </a-tooltip>
                            </a-space>
                          </template>
                          <a-tab-pane key="request" :title="$t('vuln.exploit.request')" v-if="result && result.request">
                            <div class="code-container" :class="{'dark-mode': isDarkMode}">
                              <Codemirror
                                v-model="requestContent"
                                :extensions="httpExtension"
                                :indent-with-tab="false"
                                :tab-size="2"
                                :style="{ height: '400px', width: '100%' }"
                                readonly
                              />
                            </div>
                          </a-tab-pane>
                          <a-tab-pane key="response" :title="$t('vuln.exploit.response')" v-if="result && result.response">
                            <div class="code-container" :class="{'dark-mode': isDarkMode}">
                              <Codemirror
                                v-model="responseContent"
                                :extensions="getResponseExtension()"
                                :indent-with-tab="false"
                                :tab-size="2"
                                :style="{ height: '400px', width: '100%' }"
                                readonly
                              />
                            </div>
                          </a-tab-pane>
                        </a-tabs>
                      </a-card>
                    </a-tab-pane>
                    
                    <!-- 命令执行类漏洞的交互Shell界面 -->
                    <a-tab-pane key="4" title="交互式Shell" v-if="isCommandExecution && result?.success">
                      <a-card class="result-card" :bordered="false" size="small">
                        <template #title>
                          <div class="result-card-title">
                            <icon-command class="result-icon success" />
                            <span>命令执行交互式Shell</span>
                          </div>
                        </template>
                        <div style="height: 400px;">
                          <CommandShell 
                            :target="formData.target" 
                            :cmd-param="getCmdParamKey()"
                            :method="formData.method || 'GET'"
                            :prefix="formData.prefix || ''"
                            :suffix="formData.suffix || ''"
                            :shell-type="formData.shell_type || 'bash'"
                            :proxy-url="formData.proxy_url"
                            :title="selectedPlugin?.name + ' - 交互式Shell'"
                            @command-executed="handleCommandExecuted"
                          />
                        </div>
                      </a-card>
                    </a-tab-pane>
                  </a-tabs>
                </div>
              </div>
            </div>
          </a-card>
          <a-empty v-else :description="$t('vuln.exploit.selectPluginTip')" />
        </a-col>
      </a-row>
    <!-- </a-card> -->
  </div>
</template>

<script lang="ts" setup>
// 添加组件名称，用于keep-alive识别
defineOptions({
  name: 'exploit'
});

import { ref, reactive, computed, onMounted, watch, nextTick } from 'vue';
import { useI18n } from 'vue-i18n';
import { Message, Notification } from '@arco-design/web-vue';
import type { DescData } from '@arco-design/web-vue';
import { invoke } from '@tauri-apps/api/core';
// 暂时注释掉这些可能导致错误的import
// import { saveAs } from 'file-saver';
// import * as fileSystem from '@tauri-apps/api/fs';
// import * as path from '@tauri-apps/api/path';
import { 
  getAllPlugins, 
} from '@/api/vuln';
import { 
  VulnPlugin, 
  ExploitResult, 
  SeverityLevel, 
  PluginParamDef,
} from '@/views/vuln/types/plugin';
import CommandShell from './CommandShell.vue';
import { IconCommand } from '@arco-design/web-vue/es/icon';
// 导入 CodeMirror 相关依赖
import { Codemirror } from 'vue-codemirror';
import { json } from '@codemirror/lang-json';
import { html } from '@codemirror/lang-html';
import { xml } from '@codemirror/lang-xml';
import { EditorView } from '@codemirror/view';
import { oneDark } from '@codemirror/theme-one-dark';

// 扩展DescData类型，添加risk属性
interface ExtendedDescData extends DescData {
  risk?: boolean;
}

const { t } = useI18n();
const loading = ref(false);
const exploiting = ref(false);
const plugins = ref<VulnPlugin[]>([]);
const selectedPlugin = ref<VulnPlugin | null>(null);
const selectedPluginId = ref<string | null>(null);
const searchKeyword = ref('');
const formData = reactive<Record<string, any>>({
  target: '',
});
const result = ref<ExploitResult | null>(null);
const expandedKeys = ref<string[]>([]);



// 添加 CodeMirror 相关的数据
const requestContent = ref('');
const responseContent = ref('');

// 添加暗黑模式状态
const isDarkMode = ref(false);

// 切换暗黑模式
const toggleDarkMode = () => {
  isDarkMode.value = !isDarkMode.value;
};

// CodeMirror 扩展
const baseTheme = computed(() => {
  return EditorView.theme({
    "&": {
      height: "100%",
    },
    ".cm-scroller": {
      overflow: "auto",
      fontFamily: "'Consolas', 'Monaco', 'Courier New', monospace"
    },
    ".cm-content": {
      padding: "8px",
      fontSize: "13px"
    },
    ".cm-gutters": {
      backgroundColor: isDarkMode.value ? "#262626" : "#f5f5f5",
      color: isDarkMode.value ? "#888" : "#999",
      border: "none"
    },
    ".cm-activeLineGutter": {
      backgroundColor: isDarkMode.value ? "#333" : "#e8f2ff"
    },
    ".cm-activeLine": {
      backgroundColor: isDarkMode.value ? "#333" : "#e8f2ff"
    },
    ".cm-selectionBackground": {
      backgroundColor: isDarkMode.value ? "#4b4b4b" : "#d7d4f0"
    },
    ".cm-cursor": {
      borderLeft: `2px solid ${isDarkMode.value ? '#fff' : '#000'}`
    },
    ".cm-line": {
      padding: "0 4px"
    }
  });
});

// 使用基础扩展，因为没有专门的HTTP语言支持
const httpExtension = computed(() => [
  baseTheme.value,
  ...(isDarkMode.value ? [oneDark] : [])
]);

const jsonExtension = computed(() => [
  json(),
  baseTheme.value,
  ...(isDarkMode.value ? [oneDark] : [])
]);

const htmlExtension = computed(() => [
  html(),
  baseTheme.value,
  ...(isDarkMode.value ? [oneDark] : [])
]);

const xmlExtension = computed(() => [
  xml(),
  baseTheme.value,
  ...(isDarkMode.value ? [oneDark] : [])
]);

// 根据内容类型判断使用哪种扩展
const getResponseExtension = () => {
  if (!result.value) return httpExtension.value;
  
  // 尝试从响应体判断
  if (result.value.response) {
    const response = result.value.response;
    
    // 尝试从响应头中提取Content-Type
    const contentTypeMatch = response.match(/content-type:\s*([^\r\n]+)/i);
    if (contentTypeMatch) {
      const contentType = contentTypeMatch[1].toLowerCase();
      if (contentType.includes('application/json')) {
        return jsonExtension.value;
      } else if (contentType.includes('text/html')) {
        return htmlExtension.value;
      } else if (contentType.includes('application/xml') || contentType.includes('text/xml')) {
        return xmlExtension.value;
      }
    }
    
    // 尝试从内容判断
    if (response.includes('<?xml') || response.includes('<xml')) {
      return xmlExtension.value;
    } else if (response.includes('<!DOCTYPE html') || response.includes('<html')) {
      return htmlExtension.value;
    } else if ((response.includes('{') && response.includes('}')) || 
               (response.includes('[') && response.includes(']'))) {
      try {
        // 尝试提取JSON部分
        const jsonMatch = response.match(/(\{[\s\S]*\}|\[[\s\S]*\])/);
        if (jsonMatch) {
          JSON.parse(jsonMatch[1]);
          return jsonExtension.value;
        }
      } catch (e) {
        // 不是有效的JSON
      }
    }
  }
  
  // 默认使用基础扩展
  return httpExtension.value;
};

// 监听result变化，处理HTTP数据
watch(() => result.value, () => {
  // 使用nextTick确保DOM已更新
  nextTick(() => {
    processHttpData();
  });
}, { deep: true });

// 处理HTTP数据渲染，确保换行正确显示
const processHttpData = () => {
  if (result.value) {
    // 处理请求数据
    if (result.value.request) {
      // 格式化HTTP请求数据
      requestContent.value = formatHttpData(result.value.request);
    } else {
      requestContent.value = '';
    }
    
    // 处理响应数据
    if (result.value.response) {
      // 格式化HTTP响应数据
      responseContent.value = formatHttpData(result.value.response);
    } else {
      responseContent.value = '';
    }
  } else {
    requestContent.value = '';
    responseContent.value = '';
  }
};

// 格式化HTTP数据
const formatHttpData = (httpData: string): string => {
  if (!httpData) return '';
  
  // 先处理转义字符
  let text = httpData
    .replace(/\\r\\n/g, '\r\n')
    .replace(/\\n/g, '\n')
    .replace(/\\r/g, '\r')
    .replace(/\\t/g, '\t');
  
  // 尝试解析和格式化HTTP数据
  try {
    // 分离请求/响应行、头部和正文
    const parts = text.split(/\r\n\r\n|\n\n/);
    
    if (parts.length >= 2) {
      const headers = parts[0];
      const body = parts.slice(1).join('\n\n');
      
      // 格式化头部，确保每个头部在新行
      const formattedHeaders = headers
        .split(/\r\n|\n/)
        .map(line => line.trim())
        .join('\n');
      
      // 尝试格式化正文（如果是JSON）
      let formattedBody = body;
      try {
        // 检查是否是JSON
        const contentTypeMatch = headers.match(/content-type:\s*(application\/json)/i);
        if (contentTypeMatch || (body.trim().startsWith('{') && body.trim().endsWith('}'))) {
          const jsonObj = JSON.parse(body.trim());
          formattedBody = JSON.stringify(jsonObj, null, 2);
        }
      } catch (e) {
        // 如果不是有效的JSON，保持原样
        console.log('Body is not valid JSON, keeping as is');
      }
      
      // 组合格式化后的头部和正文
      return formattedHeaders + '\n\n' + formattedBody;
    }
  } catch (e) {
    console.error('Error formatting HTTP data:', e);
  }
  
  // 如果解析失败，返回原始文本
  return text;
};

// 根据关键词筛选插件列表
const filteredPlugins = computed(() => {
  if (!searchKeyword.value) return plugins.value;
  
  const keyword = searchKeyword.value.toLowerCase();
  return plugins.value.filter(plugin => 
    plugin.name.toLowerCase().includes(keyword) || 
    plugin.description.toLowerCase().includes(keyword) ||
    plugin.rtype.toLowerCase().includes(keyword)
  );
});

// 获取每种类型的插件数量
const getPluginCountByType = (type: string) => {
  return plugins.value.filter(plugin => plugin.rtype === type).length;
};

// 获取插件类型的翻译，若无匹配则显示"其它"
const getPluginTypeTranslation = (type: string): string => {
  const translationKey = `vuln.pluginType.${type}`;
  const translation = t(translationKey);
  
  // 如果翻译键不存在或返回了空值，使用"其它"类型的翻译
  if (translation === translationKey) {
    return t('vuln.pluginType.other');
  }
  
  return translation;
};

// 构建树形数据结构
const pluginTreeData = computed(() => {
  const typeMap = new Map<string, VulnPlugin[]>();
  const searchResult = filteredPlugins.value;
  
  // 按类型分组插件
  searchResult.forEach(plugin => {
    const type = plugin.rtype || 'other';
    if (!typeMap.has(type)) {
      typeMap.set(type, []);
    }
    typeMap.get(type)?.push(plugin);
  });
  
  // 生成树形结构
  const treeData: any[] = [];
  
  Array.from(typeMap.entries()).forEach(([type, pluginList]) => {
    // 如果该类型有插件，添加类型节点
    if (pluginList.length > 0) {
      const keyword = searchKeyword.value.toLowerCase();
      const isTypeMatch = keyword && type.toLowerCase().includes(keyword);
      
      const typeNode = {
        key: type,
        title: getPluginTypeTranslation(type),
        selectable: false, // 类型节点不可选择
        isSearchMatch: isTypeMatch,
        children: pluginList.map(plugin => {
          // 判断各种匹配类型
          const isNameMatch = keyword && plugin.name.toLowerCase().includes(keyword);
          const isDescMatch = keyword && plugin.description.toLowerCase().includes(keyword);
          
          return {
            key: String(plugin.id), // 确保ID是字符串
            title: plugin.name,
            isLeaf: true,
            severity: plugin.severity,
            // 如果在搜索状态下，标记匹配的节点
            isSearchMatch: (isNameMatch || isDescMatch || isTypeMatch) && !!searchKeyword.value,
            // 记录匹配原因，用于可能的UI提示
            matchReason: isNameMatch 
              ? 'name' 
              : isDescMatch 
                ? 'description' 
                : isTypeMatch 
                  ? 'type' 
                  : ''
          };
        })
      };
      treeData.push(typeNode);
    }
  });
  
  return treeData;
});

// 处理树节点选择
const handleTreeSelect = (_selectedKeys: (string | number)[], info: any) => {
  const nodeData = info.node;
  
  // 只有叶子节点才包含插件
  if (nodeData.isLeaf) {
    selectedPluginId.value = String(nodeData.key);
    
    // 在树节点中直接寻找并获取插件
    const pluginId = selectedPluginId.value;
    const plugin = plugins.value.find(p => String(p.id) === pluginId);
    
    if (plugin) {
      handleSelectPlugin(plugin);
    } else {
      console.error('无法找到选中的插件:', pluginId);
    }
  }
};

// 获取所有插件
const fetchPlugins = async () => {
  loading.value = true;
  try {
    plugins.value = await getAllPlugins();
    return true; // 返回一个成功状态
  } catch (error) {
    Message.error(t('vuln.exploit.fetchError'));
    console.error('Error fetching plugins:', error);
    return false; // 返回一个失败状态
  } finally {
    loading.value = false;
  }
};

// 选择插件
const handleSelectPlugin = (plugin: VulnPlugin) => {
  selectedPlugin.value = plugin;
  
  // 重置表单数据，使用插件默认值
  formData.target = '';
  formData.proxy_url = '';
  
  // 重置动态参数 - 防止卡死，优化参数处理
  if (plugin.params && Array.isArray(plugin.params)) {
    // 先清除之前的所有参数
    for (const key in formData) {
      if (key !== 'target') {
        delete formData[key];
      }
    }
    
    // 添加新的参数
    plugin.params.forEach((param: PluginParamDef) => {
      // 同时检查default和default_value属性
      if (param.default !== undefined) {
        formData[param.key] = param.default;
      } else if ((param as any).default_value !== undefined) { 
        // 使用类型断言访问可能存在的default_value属性
        formData[param.key] = (param as any).default_value;
      } else {
        formData[param.key] = '';
      }
    });
  }
  
  // 重置结果
  result.value = null;
};

// 获取插件基本信息
const getPluginBasicInfo = () => {
  if (!selectedPlugin.value) return [];
  
  return [
    {
      label: t('vuln.plugin.type'),
      value: getPluginTypeTranslation(selectedPlugin.value.rtype)
    },
    {
      label: t('vuln.plugin.severity'),
      value: selectedPlugin.value.severity ? t(`vuln.severity.${selectedPlugin.value.severity}`) : ''
    },
    {
      label: t('vuln.plugin.author'),
      value: selectedPlugin.value.author
    },
    {
      label: t('vuln.plugin.version'),
      value: selectedPlugin.value.version
    },
    {
      label: t('vuln.plugin.references'),
      value: selectedPlugin.value.references ? selectedPlugin.value.references.join(', ') : ''
    }
  ];
};

// 获取结果数据信息
const getMainResultData = () => {
  if (!result.value || !result.value.data) return [];
  
  const data = result.value.data;
  const resultInfo: ExtendedDescData[] = [];
  const testResults: ExtendedDescData[] = []; // 专门存储测试结果
  
  // 递归函数，用于格式化复杂数据类型
  const formatValue = (value: any): string => {
    if (value === null || value === undefined) {
      return '-';
    } else if (Array.isArray(value)) {
      if (value.length === 0) return '[]';
      return value.map(item => formatValue(item)).join(', ');
    } else if (typeof value === 'object') {
      return JSON.stringify(value, null, 2);
    } else {
      return String(value);
    }
  };
  
  // 首先处理测试结果，它们会显示在最上方
  if (data.test_results && typeof data.test_results === 'object') {
    const label = t(`vuln.exploit.test_results`) !== `vuln.exploit.test_results` 
      ? t(`vuln.exploit.test_results`) 
      : 'Test Results';
    
    // 将test_results对象的每个键值对转换为单独的描述项，使用扁平化符号
    Object.keys(data.test_results).forEach(testKey => {
      const testValue = data.test_results[testKey];
      const formattedValue = formatValue(testValue);
      
      // 检查测试结果是否表明有问题
      const hasIssue = typeof testValue === 'boolean' 
        ? testValue  // 如果是布尔值，true表示有问题
        : typeof testValue === 'string' 
          ? testValue.toLowerCase().includes('default') || 
            testValue.toLowerCase().includes('vuln') ||
            testValue.toLowerCase().includes('detected')
          : false;
          
      // 根据测试结果设置不同的图标和样式
      const valueDisplay = hasIssue 
        ? `🛑 ${formattedValue}` 
        : `✓ ${formattedValue}`;
      
      testResults.push({
        label: `${label} - ${testKey}`,
        value: valueDisplay,
        risk: hasIssue
      });
    });
  }
  
  // 遍历数据对象的所有键
  Object.keys(data).forEach(key => {
    // 跳过已在HTTP请求/响应中显示的数据
    if (['http_request', 'http_response', 'http_status', 'http_url', 'http_method'].includes(key)) {
      return;
    }
    
    // 跳过特殊字段，它们会在特殊部分显示
    if (['risk_level', 'info', 'cve', 'references', 'test_results'].includes(key)) {
      return;
    }
    
    const value = data[key];
    const hasRisk = typeof value === 'string' && 
      (value.toLowerCase().includes('vulnerable') || 
       value.toLowerCase().includes('detected') ||
       value.toLowerCase().includes('default'));
    
    const label = t(`vuln.exploit.${key}`) !== `vuln.exploit.${key}` 
      ? t(`vuln.exploit.${key}`) 
      : key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');
    
    // 漏洞类型加图标(使用醒目图标)
    if (key === 'type') {
      resultInfo.push({
        label,
        value: `🔍 ${value}`,
        risk: hasRisk
      });
    } else {
      resultInfo.push({
        label,
        value: hasRisk ? `⚠️ ${formatValue(value)}` : formatValue(value),
        risk: hasRisk
      });
    }
  });
  
  // 将测试结果放在最前面
  return [...testResults, ...resultInfo];
};

const getSpecialResultData = () => {
  if (!result.value || !result.value.data) return [];
  
  const data = result.value.data;
  const specialFields: ExtendedDescData[] = []; // 单独存储特殊字段
  
  // 递归函数，用于格式化复杂数据类型
  const formatValue = (value: any): string => {
    if (value === null || value === undefined) {
      return '-';
    } else if (Array.isArray(value)) {
      if (value.length === 0) return '[]';
      return value.map(item => formatValue(item)).join(', ');
    } else if (typeof value === 'object') {
      return JSON.stringify(value, null, 2);
    } else {
      return String(value);
    }
  };
  
  // 只处理特殊字段 (注意不再包含test_results)
  ['risk_level', 'info', 'cve', 'references'].forEach(key => {
    if (!(key in data)) return;
    
    const value = data[key];
    const label = t(`vuln.exploit.${key}`) !== `vuln.exploit.${key}` 
      ? t(`vuln.exploit.${key}`) 
      : key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');
    
    // 对特殊字段进行简单处理，并放入特殊字段数组 (使用醒目图标)
    if (key === 'risk_level') {
      const lowerLevel = String(value).toLowerCase();
      let displayValue = value;
      let icon = '';
      
      if (lowerLevel === 'high' || lowerLevel === '高') {
        icon = '🔴';
        displayValue = `${icon} ${value} (${t('vuln.risk.high')})`;
      } else if (lowerLevel === 'medium' || lowerLevel === '中') {
        icon = '🟠';
        displayValue = `${icon} ${value} (${t('vuln.risk.medium')})`;
      } else if (lowerLevel === 'low' || lowerLevel === '低') {
        icon = '🟡';
        displayValue = `${icon} ${value} (${t('vuln.risk.low')})`;
      }
      
      specialFields.push({
        label,
        value: displayValue,
        risk: lowerLevel === 'high' || lowerLevel === '高' || lowerLevel === 'medium' || lowerLevel === '中'
      });
    } else if (key === 'info') {
      // 漏洞信息使用醒目图标
      specialFields.push({
        label,
        value: `ℹ️ ${value}`,
        risk: false
      });
    } else if (key === 'cve' && Array.isArray(value)) {
      // CVE列表使用醒目图标
      const formattedValue = value.length > 0 
        ? `⚠️ ${value.join(', ')}` 
        : '-';
      specialFields.push({
        label,
        value: formattedValue,
        risk: value.length > 0
      });
    } else if (key === 'references' && Array.isArray(value)) {
      // 引用链接使用醒目图标
      const formattedValue = value.length > 0 
        ? `🔗 ${value.join('\n🔗 ')}` 
        : '-';
      specialFields.push({
        label,
        value: formattedValue,
        risk: false
      });
    }
  });
  
  return specialFields;
};

// 获取风险级别的标签颜色
const getSeverityColor = (severity: SeverityLevel | undefined) => {
  if (!severity) return '';
  
  switch (severity) {
    case SeverityLevel.CRITICAL:
      return 'rgb(var(--danger-6))';
    case SeverityLevel.HIGH:
      return 'rgb(var(--orange-6))';
    case SeverityLevel.MEDIUM:
      return 'rgb(var(--warning-6))';
    case SeverityLevel.LOW:
      return 'rgb(var(--success-6))';
    case SeverityLevel.INFO:
      return 'rgb(var(--gray-6))';
    default:
      return '';
  }
};

// 获取严重级别标签
const getSeverityLabel = (severity: SeverityLevel | undefined) => {
  if (!severity) return '';
  return t(`vuln.severity.${severity}`);
};

// 文件上传处理函数
const handleFileUpload = (options: any, paramKey: string): Record<string, any> => {
  const file = options.file;
  if (!file) return {};
  
  // 读取文件内容
  const reader = new FileReader();
  reader.onload = (e) => {
    if (e.target?.result) {
      // 将文件内容和文件名保存到表单数据中
      formData[paramKey] = {
        name: file.name,
        content: e.target.result
      };
      options.onSuccess && options.onSuccess();
    }
  };
  
  reader.onerror = (e) => {
    options.onError && options.onError(e);
  };
  
  // 根据不同类型读取文件
  if (file.type.startsWith('text/') || file.type === 'application/json') {
    reader.readAsText(file);
  } else {
    reader.readAsDataURL(file);
  }
  
  // 返回一个空对象以满足UploadRequest类型要求
  return {};
};

// 获取文件名函数
const getFileName = (fileData: any): string => {
  if (!fileData || !fileData.name) return '';
  return fileData.name;
};

// 执行漏洞利用
const handleExploit = async () => {
  if (!selectedPlugin.value || !formData.target) {
    Message.error(t('vuln.exploit.targetRequired'));
    return;
  }
  
  exploiting.value = true;
  try {
    // 构造自定义参数对象
    const customParams: Record<string, any> = {};
    if (selectedPlugin.value.params && Array.isArray(selectedPlugin.value.params)) {
      for (const param of selectedPlugin.value.params) {
        if (formData[param.key] !== undefined) {
          customParams[param.key] = formData[param.key];
        }
      }
    }
    
    // 添加代理URL参数
    if (formData.proxy_url) {
      customParams.proxy_url = formData.proxy_url;
    }
    
    // 调试输出
    console.log('发送到后端的参数:', {
      plugin_name: selectedPlugin.value.name,
      plugin_type: selectedPlugin.value.rtype,
      target: formData.target,
      custom_params: customParams
    });
    
    let exploitResult;
    exploitResult = await invoke('execute_rhai_plugin', {
        params: {
          plugin_name: selectedPlugin.value.name,
          plugin_type: selectedPlugin.value.rtype,
          target: formData.target,
          custom_params: customParams,
          include_http_data: true // 显式请求包含HTTP数据
        }
      }) as ExploitResult;
    
    result.value = exploitResult;
    
    // 确保请求响应数据存在，如果后端没有提供，则显示占位文本
    if (!result.value.request) {
      result.value.request = t('vuln.exploit.noRequestData');
    }
    
    if (!result.value.response) {
      result.value.response = t('vuln.exploit.noResponseData');
    }
    
    // 分离执行成功和漏洞检测结果
    // 只要能够获取到结果，就认为执行成功
    if (result.value !== null) {
      // 使用全局通知替代消息提示
      Notification.success({
        title: t('vuln.exploit.executeSuccess'),
        content: selectedPlugin.value.name,
        position: 'topRight',
        duration: 3000
      });
      
      // 额外显示漏洞检测结果
      if (result.value.success) {
        // 使用通知提醒框显示漏洞检测结果
        Notification.warning({
          title: t('vuln.exploit.vulnerableFound'),
          content: selectedPlugin.value.name,
          position: 'topRight',
          duration: 5000
        });
      } else {
        // 提示未发现漏洞
        Notification.info({
          title: t('vuln.exploit.notVulnerable'),
          content: selectedPlugin.value.name,
          position: 'topRight',
          duration: 3000
        });
      }
    } else {
      Notification.error({
        title: t('vuln.exploit.executeFailed'),
        content: '',
        position: 'topRight',
        duration: 3000
      });
    }
  } catch (error) {
    Notification.error({
      title: t('vuln.exploit.executeError'),
      content: String(error),
      position: 'topRight',
      duration: 5000
    });
    console.error('Error executing exploit:', error);
  } finally {
    exploiting.value = false;
  }
};

// 处理搜索输入变化
const onSearchInput = () => {
  // 如果清空了搜索框，直接触发搜索
  if (!searchKeyword.value) {
    onSearchSubmit('');
  }
};

// 定义一个全局搜索提交函数，与输入框直接绑定
const onSearchSubmit = (value: string) => {
  console.log('点击搜索按钮:', value);
  
  // 执行搜索
  if (value) {
    // 有搜索词时，先确定哪些节点包含结果
    const typesWithResults = Array.from(new Set(
      plugins.value.filter(plugin => 
        plugin.name.toLowerCase().includes(value.toLowerCase()) || 
        plugin.description.toLowerCase().includes(value.toLowerCase()) ||
        plugin.rtype.toLowerCase().includes(value.toLowerCase())
      ).map(plugin => plugin.rtype || 'other')
    ));
    
    console.log('需要展开的节点:', typesWithResults);
    
    // 强制更新展开状态，只展开包含搜索结果的节点
    expandedKeys.value = [...typesWithResults];
    
    // 自动选择第一个匹配的插件
    const filtered = plugins.value.filter(plugin => 
      plugin.name.toLowerCase().includes(value.toLowerCase()) || 
      plugin.description.toLowerCase().includes(value.toLowerCase()) ||
      plugin.rtype.toLowerCase().includes(value.toLowerCase())
    );
    
    if (filtered.length > 0) {
      selectedPluginId.value = String(filtered[0].id);
      handleSelectPlugin(filtered[0]);
    }
  } else {
    // 搜索词为空时，恢复默认状态（不展开任何节点）
    expandedKeys.value = [];
  }
};

// 在组件挂载时获取插件列表和初始化树状态
onMounted(() => {
  // 获取插件列表
  fetchPlugins().then(() => {
    // 获取完成后，默认不展开任何节点
    nextTick(() => {
      // 默认不展开任何节点
      expandedKeys.value = [];
      console.log('初始状态，不展开任何节点');
    });
  });
});

// 优化hasRiskButNotExploitable计算属性，更精确地检测测试结果中的风险
const hasRiskButNotExploitable = computed(() => {
  if (!result.value || !result.value.data) return false;
  
  // 检查结果中是否包含风险信息但未成功利用
  const data = result.value.data;
  
  // 检查是否有任何测试结果表明存在问题
  let hasTestResultIssues = false;
  if (data.test_results && typeof data.test_results === 'object') {
    hasTestResultIssues = Object.values(data.test_results).some(val => {
      if (typeof val === 'boolean') return val;
      if (typeof val === 'string') {
        const lowerVal = val.toLowerCase();
        return lowerVal.includes('default') || 
               lowerVal.includes('vuln') ||
               lowerVal.includes('detected');
      }
      return false;
    });
  }
  
  return !result.value.success && 
         (hasTestResultIssues || 
          data.risk_level || 
          (data.info && data.info.toLowerCase().includes('default')) ||
          (Array.isArray(data.cve) && data.cve.length > 0));
});

// Add computed property for virtual list height
const virtualListHeight = computed(() => {
  // Default height if we can't calculate dynamically
  return 550;
});

// Add component prop defaultization
const getSelectedPluginId = computed(() => {
  return selectedPluginId.value ? [selectedPluginId.value] : [];
});

// Fix the computed properties
const mainResultData = computed(() => {
  if (!result.value || !result.value.data) return [] as ExtendedDescData[];
  return getMainResultData();
});

const specialResultData = computed(() => {
  if (!result.value || !result.value.data) return [] as ExtendedDescData[];
  return getSpecialResultData();
});

// 处理树节点展开
const handleTreeExpand = (expandKeys: (string | number)[], _data: any) => {
  console.log('树节点展开状态变化:', expandKeys);
};

// 监听expandedKeys变化
watch(expandedKeys, (newVal) => {
  console.log('expandedKeys变化:', newVal);
}, { deep: true });

// 监听filteredPlugins变化
watch(() => filteredPlugins.value.length, (newCount) => {
  console.log('过滤后的插件数量变化:', newCount);
  if (searchKeyword.value) {
    nextTick(() => {
      // 强制更新展开状态
      const typesWithResults = Array.from(new Set(
        filteredPlugins.value.map(plugin => plugin.rtype || 'other')
      ));
      console.log('插件数量变化后更新展开状态:', typesWithResults);
      expandedKeys.value = typesWithResults;
    });
  }
});

// 当选择了命令执行类漏洞，显示命令行Shell选项卡
const isCommandExecution = computed(() => {
  if (!selectedPlugin.value) return false;
  return selectedPlugin.value.name.toLowerCase().includes('命令') || 
         selectedPlugin.value.name.toLowerCase().includes('command') ||
         selectedPlugin.value.description.toLowerCase().includes('命令执行') ||
         selectedPlugin.value.description.toLowerCase().includes('command injection') ||
         selectedPlugin.value.description.toLowerCase().includes('rce');
});

// 添加命令执行处理方法
const handleCommandExecuted = (data: {command: string, output: string, success: boolean}) => {
  console.log('Command executed:', data);
  // 可以在这里添加对命令执行结果的处理逻辑
};

// 获取cmd_param参数的key
const getCmdParamKey = () => {
  console.log("selectedPlugin.value: " , selectedPlugin.value)
  if (!selectedPlugin.value) return '';
  const cmdParamDef = selectedPlugin.value.params.find(p => 
    p.key === 'cmd_param' || 
    p.name.includes('命令参数') || 
    p.name.includes('Command Parameter'));
  
  if (!cmdParamDef) return '';
  
  // 返回输入框中的值，而不是键名
  const paramValue = formData[cmdParamDef.key];
  console.log("命令参数的值: ", paramValue);
  return paramValue || '';
};

// 监听暗黑模式变化，强制重新渲染
watch(() => isDarkMode.value, () => {
  // 使用nextTick确保DOM已更新
  nextTick(() => {
    // 触发重新渲染
    if (requestContent.value) {
      const temp = requestContent.value;
      requestContent.value = '';
      nextTick(() => {
        requestContent.value = temp;
      });
    }
    
    if (responseContent.value) {
      const temp = responseContent.value;
      responseContent.value = '';
      nextTick(() => {
        responseContent.value = temp;
      });
    }
  });
});
</script>

<style lang="less" scoped>
.vuln-exploit-container {
  padding: 0;
  
  .general-card {
    margin-bottom: 16px;
  }
  
  .inner-card {
    height: 100%;
    
    :deep(.arco-card-body) {
      padding: 8px;
    }
  }
  
  .plugin-search {
    margin-bottom: 6px;

    :deep(.arco-input-wrapper) {
      padding: 1px 4px;
    }
    
    :deep(.arco-input-group-wrapper) {
      padding-bottom: 1px;
    }
  }
  
  .plugin-actions {
    display: flex;
    justify-content: flex-end;
    margin-top: 4px;
  }
  
  .plugin-list {
    height: calc(100vh - 210px);
    overflow-y: auto;
    
    :deep(.arco-tree) {
      // Condense the tree nodes
      .arco-tree-node {
        padding: 4px 0;
        
        &-selected {
          background-color: rgba(var(--primary-1), 0.5);
        }
      }
      
      // Reduce the indent space
      .arco-tree-node-indent {
        &-unit {
          width: 16px; // Default is 20px
        }
      }
      
      // Make the expand icon smaller
      .arco-tree-node-expand-icon {
        font-size: 12px;
      }
    }
  }
  
  .tree-node {
    display: flex;
    align-items: center;
    width: 100%;
    
    .plugin-tree-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      
      .plugin-name-text {
        display: inline-block;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 75%; // Increased from 70%
        font-size: 12px; // Slightly smaller font
        
        &.search-match {
          font-weight: bold;
          color: var(--color-primary-6);
          background-color: rgba(var(--primary-1), 0.3);
          border-radius: 2px;
          padding: 0 2px;
        }
      }
    }
    
    strong {
      font-size: 13px; // Make category titles slightly larger for contrast
    }
    
    .plugin-count {
      margin-left: 4px;
      font-size: 11px; // Slightly smaller than default
      color: #999;
    }
  }
  
  .plugin-detail {
    &-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    &-title {
      font-size: 16px;
      font-weight: 600;
      margin-right: 8px;
      display: flex;
      align-items: center;
      
      .title-tag {
        margin-left: 8px;
      }
    }
  }

  .compact-heading {
    font-size: 14px;
    margin: 8px 0;
    font-weight: 500;
  }
  
  .compact-card {
    :deep(.arco-card-header) {
      padding: 8px 12px;
      min-height: auto;
    }
    
    :deep(.arco-card-body) {
      padding: 10px 12px;
    }
  }
  
  .form-item-label {
    font-weight: 500;
    margin-bottom: 4px;
  }
  
  .result-card {
    margin-bottom: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    border-radius: 6px;
    transition: box-shadow 0.3s, transform 0.2s;
    
    &:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
      transform: translateY(-1px);
    }
  }
  
  .result-card-title {
    display: flex;
    align-items: center;
    gap: 8px;
    
    .result-icon {
      &.success {
        color: rgb(var(--success-6));
      }
      
      &.warning {
        color: rgb(var(--warning-6));
      }
      
      &.info {
        color: rgb(var(--gray-6));
      }
    }
  }
  
  .result-data {
    margin-bottom: 16px;
    
    .data-item {
      display: flex;
      margin-bottom: 15px;
      align-items: flex-start;
      padding: 1px 5px;
      border-radius: 4px;
      transition: all 0.2s ease;
      
      &:hover {
        background-color: var(--color-fill-2);
      }
      
      &.risk-item {
        background-color: rgba(var(--warning-1), 0.5);
        border-left: 3px solid var(--color-warning-6);
        
        &:hover {
          background-color: rgba(var(--warning-2), 0.6);
        }
      }
      
      &-label {
        width: 250px;
        color: var(--color-text-2);
        font-size: 13px;
        flex-shrink: 0;
        padding-top: 1px;
        font-weight: 500;
        padding-right: 8px;
      }
      
      &-value {
        flex: 1;
        word-break: break-word;
        
        &.risk-value {
          color: var(--color-danger-6);
          font-weight: 500;
        }
        
        &.test-result-warning {
          color: var(--color-warning-6);
          font-weight: 500;
        }
      }
    }
  }
  
  .http-data {
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    background-color: #f5f5f5;
    padding: 12px;
    border-radius: 4px;
    overflow: auto;
    max-height: 400px;
    white-space: pre;
    font-size: 13px;
    line-height: 1.5;
    tab-size: 4;
    -moz-tab-size: 4;
    -o-tab-size: 4;
    
    code {
      display: block;
      width: 100%;
      overflow-wrap: normal;
      word-break: keep-all;
      word-wrap: normal;
      overflow-x: auto;
      color: #333;
    }
  }
  
  .code-container {
    border: 1px solid #e4e7ed;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 10px;
    background-color: #fafafa;
    position: relative;
    height: 400px;
    
    :deep(.cm-editor) {
      height: 100%;
      font-size: 13px;
    }
    
    :deep(.cm-gutters) {
      background-color: #f5f5f5;
      border-right: 1px solid #e4e7ed;
    }
    
    :deep(.cm-activeLineGutter) {
      background-color: #e8f2ff;
    }
    
    :deep(.cm-activeLine) {
      background-color: #e8f2ff;
    }
    
    :deep(.cm-content) {
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    }
    
    &.dark-mode {
      background-color: #1e1e1e;
      border-color: #333;
      
      :deep(.cm-editor) {
        background-color: #1e1e1e;
      }
      
      :deep(.cm-gutters) {
        background-color: #262626;
        border-right: 1px solid #333;
      }
      
      :deep(.cm-activeLineGutter) {
        background-color: #333;
      }
      
      :deep(.cm-activeLine) {
        background-color: #333;
      }
      
      :deep(.cm-content) {
        color: #d4d4d4;
      }
    }
  }

  .additional-info-section {
    margin-top: 16px;
    border-radius: 4px;
    overflow: hidden;
    
    :deep(.arco-collapse-item-header) {
      font-size: 13px;
      font-weight: 500;
      color: var(--color-text-2);
      background-color: var(--color-fill-2);
      padding: 8px 12px;
    }
    
    :deep(.arco-collapse-content-wrapper) {
      background-color: var(--color-neutral-1);
    }
    
    :deep(.arco-collapse-content-box) {
      padding: 12px;
    }
  }

  // Make the tags more compact in the plugin tree
  :deep(.arco-tag.arco-tag-size-small) {
    padding: 0 4px;
    margin-left: 4px;
    font-size: 10px;
    line-height: 16px;
  }

  :deep(.arco-tree-node-title) {
    padding: 0 4px;
  }

  :deep(.arco-tooltip) {
    .arco-trigger-popup {
      transition-delay: 0s;
    }
  }

  .category-header {
    display: flex;
    align-items: center;
    width: 100%;
    padding: 1px 0;
    
    strong {
      font-size: 13px;
      color: #555;
      
      &.search-match {
        color: var(--color-primary-6);
        background-color: rgba(var(--primary-1), 0.2);
        border-radius: 2px;
        padding: 0 2px;
      }
    }
  }



  // Add better spacing for form buttons
  :deep(.arco-form-item) {
    margin-bottom: 12px;
    
    &:last-child {
      margin-bottom: 0;
      margin-top: 16px;
    }
  }

  // Improve card title with tag styling
  .card-title-with-tag {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    
    .arco-tag {
      margin-left: 0;
    }
  }

  // Improve detail section spacing and borders
  .detail-section {
    margin-bottom: 16px;
    padding-bottom: 4px;
    
    &:not(:last-child) {
      border-bottom: 1px solid var(--color-neutral-3);
    }
    
    &:last-child {
      margin-bottom: 0;
    }
  }

  // Improve form layout
  :deep(.arco-form) {
    .arco-row {
      margin-bottom: -4px;
    }
    
    .arco-form-item-content {
      min-height: auto;
    }
    
    .arco-form-item-label-col {
      padding-bottom: 4px;
    }
    
    .arco-form-item-wrapper {
      margin-bottom: 8px;
    }
  }

  // Style the target and advanced options sections more distinctly
  .form-item-target {
    margin-bottom: 16px;
  }

  :deep(.arco-input-wrapper) {
    padding: 0 8px;
  }

  :deep(.arco-btn) {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
  }

  .risk-high {
    color: var(--color-danger-6);
    font-weight: 500;
  }

  .risk-medium {
    color: var(--color-warning-6);
    font-weight: 500;
  }

  .risk-low {
    color: var(--color-success-6);
    font-weight: 500;
  }

  .result-section {
    .result-card {
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      
      :deep(.arco-card-header) {
        padding: 8px 12px;
        border-bottom: 1px solid var(--color-border-2);
      }
      
      :deep(.arco-card-body) {
        padding: 12px;
      }
    }
    
    .result-card-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      font-size: 14px;
      
      .result-icon {
        font-size: 16px;
        
        &.success {
          color: var(--color-danger-6);
          animation: pulse 1.5s infinite;
        }
        
        &.warning {
          color: var(--color-warning-6);
          animation: pulse 2s infinite;
        }
        
        &.info {
          color: var(--color-neutral-6);
        }
      }
    }
  }

  @keyframes pulse {
    0% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
    100% {
      opacity: 1;
    }
  }

  // CSS for the plugin dialog
  .add-plugin-dialog {
    .script-editor-container {
      border: 1px solid var(--color-border-2);
      border-radius: 4px;
      overflow: hidden;
      
      :deep(.arco-textarea-wrapper) {
        padding: 4px;
        font-family: monospace;
        
        .arco-textarea {
          font-family: monospace;
          line-height: 1.5;
        }
      }
    }
    
    .script-editor-toolbar {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 4px;
    }
    
    .validation-error {
      color: var(--color-danger-6);
      margin-top: 8px;
      padding: 8px;
      background-color: var(--color-danger-1);
      border-radius: 4px;
      font-size: 13px;
    }
    
    .parameters-list {
      margin-bottom: 16px;
      
      :deep(.arco-table-th) {
        background-color: var(--color-fill-2);
        font-weight: 500;
        padding: 6px 8px;
      }
      
      :deep(.arco-table-td) {
        padding: 6px 8px;
      }
    }
  }
}
</style>