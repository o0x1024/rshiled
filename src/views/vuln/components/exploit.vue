<template>
  <div class="vuln-exploit-container">
    <a-typography-text style="font-size: large; font-weight: 540;">{{ $t('rhai_plugin.expolit') || 'Rhai Plugin Manager'
      }}</a-typography-text>
    <!-- <a-card class="general-card" :title="$t('vuln.exploit.title')" size="small"> -->
      <a-row :gutter="12" style="margin-top: 12px;">
        <a-col :span="5">
          <a-card class="inner-card">
            <template #title>
              {{ $t('vuln.exploit.pluginList') }}
              <a-tooltip :content="$t('vuln.exploit.pluginListTip')">
                <icon-question-circle style="margin-left: 4px;" />
              </a-tooltip>
            </template>
            <div class="plugin-search">
              <a-input-search
                v-model="searchKeyword"
                :placeholder="$t('vuln.exploit.searchPlaceholder')"
                @search="onSearchSubmit"
                @input="onSearchInput"
                size="small"
              />
            </div>
            <div class="plugin-list">
              <a-spin :loading="loading">
                <a-tree
                  :data="pluginTreeData"
                  v-model:expanded-keys="expandedKeys"
                  :selected-keys="getSelectedPluginId"
                  :auto-expand-parent="true"
                  size="small"
                  @select="handleTreeSelect"
                  @expand="handleTreeExpand"
                  :virtual-list-props="{ height: virtualListHeight }"
                >
                  <template #title="nodeData">
                    <div class="tree-node">
                      <template v-if="nodeData.isLeaf">
                        <div class="plugin-tree-item">
                          <a-tooltip 
                            :content="nodeData.matchReason && searchKeyword 
                              ? `${nodeData.title} (${t(`vuln.search.match.${nodeData.matchReason}`)})`
                              : nodeData.title" 
                            position="right"
                          >
                            <span 
                              class="plugin-name-text" 
                              :class="{'search-match': nodeData.isSearchMatch && searchKeyword}"
                            >
                              {{ nodeData.title }}
                            </span>
                          </a-tooltip>
                          <a-tag v-if="nodeData.severity" :color="getSeverityColor(nodeData.severity)" size="small">
                            {{ getSeverityLabel(nodeData.severity) }}
                          </a-tag>
                        </div>
                      </template>
                      <template v-else>
                        <div class="category-header">
                          <strong :class="{'search-match': nodeData.isSearchMatch && searchKeyword}">
                            {{ nodeData.title }}
                          </strong>
                          <span class="plugin-count">
                            ({{ getPluginCountByType(nodeData.key) }})
                          </span>
                        </div>
                      </template>
                    </div>
                  </template>
                </a-tree>
              </a-spin>
            </div>
          </a-card>
        </a-col>
        <a-col :span="19">
          <a-card v-if="selectedPlugin" class="inner-card compact-card">
            <template #title>
              <div class="card-title-with-tag">
                {{ $t('vuln.exploit.pluginDetail') }}: {{ selectedPlugin.name }}
                <a-tag v-if="selectedPlugin.severity" :color="getSeverityColor(selectedPlugin.severity)" size="small">
                  {{ getSeverityLabel(selectedPlugin.severity) }}
                </a-tag>
              </div>
            </template>
            <div class="plugin-detail">
              <div class="detail-section">
                <a-collapse :default-active-keys="[]" size="small">
                  <a-collapse-item key="1" :header="$t('vuln.exploit.basicInfo')">
                    <a-descriptions :column="4" :data="getPluginBasicInfo()" size="small" />
                  </a-collapse-item>
                </a-collapse>
              </div>
              
              <a-divider style="margin: 8px 0 12px 0" />
              
              <div class="detail-section">
                <h4 class="compact-heading" style="margin-bottom: 12px; display: flex; align-items: center;">
                  <icon-play-circle style="margin-right: 4px;" />
                  {{ $t('vuln.exploit.parameters') }}
                </h4>
                <a-form ref="formRef" :model="formData" layout="vertical" size="small">
                  <!-- ÁõÆÊ†áÂèÇÊï∞ÔºåÊâÄÊúâÊºèÊ¥ûÂà©Áî®ÈÉΩÈúÄË¶Å -->
                  <a-form-item
                    field="target"
                    :label="$t('vuln.exploit.target')"
                    required
                    style="margin-bottom: 16px;"
                  >
                    <a-input
                      v-model="formData.target"
                      :placeholder="$t('vuln.exploit.targetPlaceholder')"
                    />
                  </a-form-item>
                
                  <!-- È´òÁ∫ßÈÄâÈ°πÊäòÂè†Èù¢Êùø -->
                  <a-collapse :default-active-keys="[]" style="margin-bottom: 16px;" size="small">
                    <a-collapse-item :header="$t('vuln.exploit.advancedOptions')" key="1">
                      <a-row :gutter="12">
                        <!-- ‰ª£ÁêÜURLÂèÇÊï∞ -->
                        <a-col :span="12" style="padding-bottom: 8px;">
                          <a-form-item
                            field="proxy_url"
                            :label="$t('vuln.exploit.proxyUrl')"
                          >
                            <a-input
                              v-model="formData.proxy_url"
                              :placeholder="$t('vuln.exploit.proxyUrlPlaceholder')"
                            />
                          </a-form-item>
                        </a-col>
                        
                        <!-- ÂÖ∂‰ªñÂä®ÊÄÅÂèÇÊï∞ -->
                        <template v-for="(param) in selectedPlugin.params.filter(p => p.key !== 'proxy_url')" :key="param.key">
                          <a-col :span="12" style="padding-bottom: 8px;">
                            <a-form-item
                              :field="param.key"
                              :label="param.name"
                              :required="param.required"
                              :extra="param.description"
                            >
                              <a-input
                                v-if="param.type === 'string'"
                                v-model="formData[param.key]"
                                :placeholder="param.description"
                              />
                              <a-input-number
                                v-else-if="param.type === 'number'"
                                v-model="formData[param.key]"
                                :placeholder="param.description"
                              />
                              <a-textarea
                                v-else-if="param.type === 'textarea'"
                                v-model="formData[param.key]"
                                :placeholder="param.description"
                              />
                              <a-switch
                                v-else-if="param.type === 'boolean'"
                                v-model="formData[param.key]"
                              />
                              <a-select
                                v-else-if="param.type === 'select'"
                                v-model="formData[param.key]"
                                :placeholder="param.description"
                              >
                                <a-option
                                  v-for="option in param.options || []"
                                  :key="option.value"
                                  :value="option.value"
                                >
                                  {{ option.label }}
                                </a-option>
                              </a-select>
                              <a-upload
                                v-else-if="param.type === 'file'"
                                :custom-request="(options) => handleFileUpload(options, param.key)"
                                :show-file-list="false"
                              >
                                <a-button size="small">
                                  {{ $t('vuln.exploit.selectFile') }}
                                </a-button>
                                <div v-if="formData[param.key]" style="margin-top: 4px; font-size: 12px;">
                                  {{ getFileName(formData[param.key]) }}
                                </div>
                              </a-upload>
                            </a-form-item>
                          </a-col>
                        </template>
                      </a-row>
                    </a-collapse-item>
                  </a-collapse>
                  
                  <a-form-item style="margin-top: 16px; display: flex; justify-content: flex-end;">
                    <a-button type="primary" @click="handleExploit" :loading="exploiting" size="small" style="min-width: 120px;">
                      <template #icon><icon-play-circle /></template>
                      {{ $t('vuln.exploit.execute') }}
                    </a-button>
                  </a-form-item>
                </a-form>
              </div>
              
              <a-divider v-if="result" margin="8px 0" />
              
              <div v-if="result" class="detail-section">
                <h4 class="compact-heading">{{ $t('vuln.exploit.result') }}</h4>
                
                <!-- HTTP ËØ∑Ê±ÇÂìçÂ∫îÂ±ïÁ§∫Âå∫ -->
                <div class="http-packet-container">
                  <a-tabs default-active-key="1" type="card-gutter" size="small">
                    <a-tab-pane key="1" :title="$t('vuln.exploit.data')">
                      <div v-if="result && result.data" class="result-section">
                        <a-card class="result-card" :bordered="false" size="small">
                          <template #title>
                            <div class="result-card-title">
                              <icon-check-circle-fill v-if="result.success" class="result-icon success" />
                              <icon-exclamation-circle-fill v-else-if="hasRiskButNotExploitable" class="result-icon warning" />
                              <icon-close-circle-fill v-else class="result-icon info" />
                              <span>{{ 
                                result.success 
                                  ? $t('vuln.exploit.vulnerableFound') 
                                  : (hasRiskButNotExploitable 
                                      ? $t('vuln.exploit.riskFoundNotExploitable') 
                                      : $t('vuln.exploit.notVulnerable'))
                              }}</span>
                            </div>
                          </template>
                          
                          <!-- Main Results -->
                          <div v-if="mainResultData.length > 0" class="result-data">
                            <div v-for="(item, index) in mainResultData" :key="index" 
                              class="data-item" :class="{'risk-item': item.risk}">
                              <a-space direction="vertical">
                                <a-space>
                                  <div class="data-item-label">{{ item.label }}</div>
                                  <div class="data-item-value" :class="{'risk-value': item.risk}">
                                    {{ item.value }}
                                  </div>
                                </a-space>
                              </a-space>
                              <!-- <div class="data-item-label">{{ item.label }}</div>
                              <div class="data-item-value" :class="{'risk-value': item.risk}">
                                {{ item.value }} -->
                              <!-- </div> -->
                            </div>
                          </div>
                          
                          <!-- Additional Information Section -->
                          <div v-if="specialResultData.length > 0" >
                            <a-collapse :default-active-keys="['1']" size="small">
                              <a-collapse-item key="1">
                                <template #header>{{ $t('vuln.exploit.additionalInfo') }}</template>
                                <div v-for="(item, index) in specialResultData" :key="index" 
                                  class="data-item" :class="{'risk-item': item.risk}">

                                  <a-space direction="vertical">
                                    <div class="data-item-label">{{ item.label }}</div>
                                    <div class="data-item-value" :class="{'risk-value': item.risk}">
                                      {{ item.value }}
                                    </div>
                                  </a-space>



                                  <!-- <div class="data-item-label">{{ item.label }}</div>
                                  <div class="data-item-value" :class="{'risk-value': item.risk}">
                                    {{ item.value }}
                                  </div> -->
                                </div>
                              </a-collapse-item>
                            </a-collapse>
                          </div>
                        </a-card>
                      </div>
                      <a-empty v-else :description="$t('vuln.exploit.noData')" />
                    </a-tab-pane>
                    <a-tab-pane key="2" :title="$t('vuln.exploit.details')">
                      <div v-if="result && result.raw_output" class="result-details">
                        <a-card class="result-card" :bordered="false" size="small">
                          <template #title>
                            <div class="result-card-title">
                              <icon-code class="result-icon info" />
                              <span>{{ $t('vuln.exploit.rawOutput') }}</span>
                            </div>
                          </template>
                          <div class="raw-output-wrapper">
                            <pre>{{ result.raw_output }}</pre>
                          </div>
                        </a-card>
                      </div>
                      <a-empty v-else :description="$t('vuln.exploit.noDetails')" />
                    </a-tab-pane>
                    <a-tab-pane key="3" :title="$t('vuln.exploit.httpData')" v-if="result && (result.request || result.response)">
                      <a-card class="result-card" :bordered="false" size="small">
                        <a-tabs type="text" size="small">
                          <template #extra>
                            <a-space size="small">
                              <a-tooltip :content="$t('vuln.exploit.darkMode') || 'ÊöóÈªëÊ®°Âºè'">
                                <a-button shape="circle" size="mini" :type="isDarkMode ? 'primary' : 'outline'"
                                  @click="toggleDarkMode">
                                  <icon-moon />
                                </a-button>
                              </a-tooltip>
                            </a-space>
                          </template>
                          <a-tab-pane key="request" :title="$t('vuln.exploit.request')" v-if="result && result.request">
                            <div class="code-container" :class="{'dark-mode': isDarkMode}">
                              <Codemirror
                                v-model="requestContent"
                                :extensions="httpExtension"
                                :indent-with-tab="false"
                                :tab-size="2"
                                :style="{ height: '400px', width: '100%' }"
                                readonly
                              />
                            </div>
                          </a-tab-pane>
                          <a-tab-pane key="response" :title="$t('vuln.exploit.response')" v-if="result && result.response">
                            <div class="code-container" :class="{'dark-mode': isDarkMode}">
                              <Codemirror
                                v-model="responseContent"
                                :extensions="getResponseExtension()"
                                :indent-with-tab="false"
                                :tab-size="2"
                                :style="{ height: '400px', width: '100%' }"
                                readonly
                              />
                            </div>
                          </a-tab-pane>
                        </a-tabs>
                      </a-card>
                    </a-tab-pane>
                    
                    <!-- ÂëΩ‰ª§ÊâßË°åÁ±ªÊºèÊ¥ûÁöÑ‰∫§‰∫íShellÁïåÈù¢ -->
                    <a-tab-pane key="4" title="‰∫§‰∫íÂºèShell" v-if="isCommandExecution && result?.success">
                      <a-card class="result-card" :bordered="false" size="small">
                        <template #title>
                          <div class="result-card-title">
                            <icon-command class="result-icon success" />
                            <span>ÂëΩ‰ª§ÊâßË°å‰∫§‰∫íÂºèShell</span>
                          </div>
                        </template>
                        <div style="height: 400px;">
                          <CommandShell 
                            :target="formData.target" 
                            :cmd-param="getCmdParamKey()"
                            :method="formData.method || 'GET'"
                            :prefix="formData.prefix || ''"
                            :suffix="formData.suffix || ''"
                            :shell-type="formData.shell_type || 'bash'"
                            :proxy-url="formData.proxy_url"
                            :title="selectedPlugin?.name + ' - ‰∫§‰∫íÂºèShell'"
                            @command-executed="handleCommandExecuted"
                          />
                        </div>
                      </a-card>
                    </a-tab-pane>
                  </a-tabs>
                </div>
              </div>
            </div>
          </a-card>
          <a-empty v-else :description="$t('vuln.exploit.selectPluginTip')" />
        </a-col>
      </a-row>
    <!-- </a-card> -->
  </div>
</template>

<script lang="ts" setup>
// Ê∑ªÂä†ÁªÑ‰ª∂ÂêçÁß∞ÔºåÁî®‰∫ékeep-aliveËØÜÂà´
defineOptions({
  name: 'exploit'
});

import { ref, reactive, computed, onMounted, watch, nextTick } from 'vue';
import { useI18n } from 'vue-i18n';
import { Message, Notification } from '@arco-design/web-vue';
import type { DescData } from '@arco-design/web-vue';
import { invoke } from '@tauri-apps/api/core';
// ÊöÇÊó∂Ê≥®ÈáäÊéâËøô‰∫õÂèØËÉΩÂØºËá¥ÈîôËØØÁöÑimport
// import { saveAs } from 'file-saver';
// import * as fileSystem from '@tauri-apps/api/fs';
// import * as path from '@tauri-apps/api/path';
import { 
  getAllPlugins, 
} from '@/api/vuln';
import { 
  VulnPlugin, 
  ExploitResult, 
  SeverityLevel, 
  PluginParamDef,
} from '@/views/vuln/types/plugin';
import CommandShell from './CommandShell.vue';
import { IconCommand } from '@arco-design/web-vue/es/icon';
// ÂØºÂÖ• CodeMirror Áõ∏ÂÖ≥‰æùËµñ
import { Codemirror } from 'vue-codemirror';
import { json } from '@codemirror/lang-json';
import { html } from '@codemirror/lang-html';
import { xml } from '@codemirror/lang-xml';
import { EditorView } from '@codemirror/view';
import { oneDark } from '@codemirror/theme-one-dark';

// Êâ©Â±ïDescDataÁ±ªÂûãÔºåÊ∑ªÂä†riskÂ±ûÊÄß
interface ExtendedDescData extends DescData {
  risk?: boolean;
}

const { t } = useI18n();
const loading = ref(false);
const exploiting = ref(false);
const plugins = ref<VulnPlugin[]>([]);
const selectedPlugin = ref<VulnPlugin | null>(null);
const selectedPluginId = ref<string | null>(null);
const searchKeyword = ref('');
const formData = reactive<Record<string, any>>({
  target: '',
});
const result = ref<ExploitResult | null>(null);
const expandedKeys = ref<string[]>([]);



// Ê∑ªÂä† CodeMirror Áõ∏ÂÖ≥ÁöÑÊï∞ÊçÆ
const requestContent = ref('');
const responseContent = ref('');

// Ê∑ªÂä†ÊöóÈªëÊ®°ÂºèÁä∂ÊÄÅ
const isDarkMode = ref(false);

// ÂàáÊç¢ÊöóÈªëÊ®°Âºè
const toggleDarkMode = () => {
  isDarkMode.value = !isDarkMode.value;
};

// CodeMirror Êâ©Â±ï
const baseTheme = computed(() => {
  return EditorView.theme({
    "&": {
      height: "100%",
    },
    ".cm-scroller": {
      overflow: "auto",
      fontFamily: "'Consolas', 'Monaco', 'Courier New', monospace"
    },
    ".cm-content": {
      padding: "8px",
      fontSize: "13px"
    },
    ".cm-gutters": {
      backgroundColor: isDarkMode.value ? "#262626" : "#f5f5f5",
      color: isDarkMode.value ? "#888" : "#999",
      border: "none"
    },
    ".cm-activeLineGutter": {
      backgroundColor: isDarkMode.value ? "#333" : "#e8f2ff"
    },
    ".cm-activeLine": {
      backgroundColor: isDarkMode.value ? "#333" : "#e8f2ff"
    },
    ".cm-selectionBackground": {
      backgroundColor: isDarkMode.value ? "#4b4b4b" : "#d7d4f0"
    },
    ".cm-cursor": {
      borderLeft: `2px solid ${isDarkMode.value ? '#fff' : '#000'}`
    },
    ".cm-line": {
      padding: "0 4px"
    }
  });
});

// ‰ΩøÁî®Âü∫Á°ÄÊâ©Â±ïÔºåÂõ†‰∏∫Ê≤°Êúâ‰∏ìÈó®ÁöÑHTTPËØ≠Ë®ÄÊîØÊåÅ
const httpExtension = computed(() => [
  baseTheme.value,
  ...(isDarkMode.value ? [oneDark] : [])
]);

const jsonExtension = computed(() => [
  json(),
  baseTheme.value,
  ...(isDarkMode.value ? [oneDark] : [])
]);

const htmlExtension = computed(() => [
  html(),
  baseTheme.value,
  ...(isDarkMode.value ? [oneDark] : [])
]);

const xmlExtension = computed(() => [
  xml(),
  baseTheme.value,
  ...(isDarkMode.value ? [oneDark] : [])
]);

// Ê†πÊçÆÂÜÖÂÆπÁ±ªÂûãÂà§Êñ≠‰ΩøÁî®Âì™ÁßçÊâ©Â±ï
const getResponseExtension = () => {
  if (!result.value) return httpExtension.value;
  
  // Â∞ùËØï‰ªéÂìçÂ∫î‰ΩìÂà§Êñ≠
  if (result.value.response) {
    const response = result.value.response;
    
    // Â∞ùËØï‰ªéÂìçÂ∫îÂ§¥‰∏≠ÊèêÂèñContent-Type
    const contentTypeMatch = response.match(/content-type:\s*([^\r\n]+)/i);
    if (contentTypeMatch) {
      const contentType = contentTypeMatch[1].toLowerCase();
      if (contentType.includes('application/json')) {
        return jsonExtension.value;
      } else if (contentType.includes('text/html')) {
        return htmlExtension.value;
      } else if (contentType.includes('application/xml') || contentType.includes('text/xml')) {
        return xmlExtension.value;
      }
    }
    
    // Â∞ùËØï‰ªéÂÜÖÂÆπÂà§Êñ≠
    if (response.includes('<?xml') || response.includes('<xml')) {
      return xmlExtension.value;
    } else if (response.includes('<!DOCTYPE html') || response.includes('<html')) {
      return htmlExtension.value;
    } else if ((response.includes('{') && response.includes('}')) || 
               (response.includes('[') && response.includes(']'))) {
      try {
        // Â∞ùËØïÊèêÂèñJSONÈÉ®ÂàÜ
        const jsonMatch = response.match(/(\{[\s\S]*\}|\[[\s\S]*\])/);
        if (jsonMatch) {
          JSON.parse(jsonMatch[1]);
          return jsonExtension.value;
        }
      } catch (e) {
        // ‰∏çÊòØÊúâÊïàÁöÑJSON
      }
    }
  }
  
  // ÈªòËÆ§‰ΩøÁî®Âü∫Á°ÄÊâ©Â±ï
  return httpExtension.value;
};

// ÁõëÂê¨resultÂèòÂåñÔºåÂ§ÑÁêÜHTTPÊï∞ÊçÆ
watch(() => result.value, () => {
  // ‰ΩøÁî®nextTickÁ°Æ‰øùDOMÂ∑≤Êõ¥Êñ∞
  nextTick(() => {
    processHttpData();
  });
}, { deep: true });

// Â§ÑÁêÜHTTPÊï∞ÊçÆÊ∏≤ÊüìÔºåÁ°Æ‰øùÊç¢Ë°åÊ≠£Á°ÆÊòæÁ§∫
const processHttpData = () => {
  if (result.value) {
    // Â§ÑÁêÜËØ∑Ê±ÇÊï∞ÊçÆ
    if (result.value.request) {
      // Ê†ºÂºèÂåñHTTPËØ∑Ê±ÇÊï∞ÊçÆ
      requestContent.value = formatHttpData(result.value.request);
    } else {
      requestContent.value = '';
    }
    
    // Â§ÑÁêÜÂìçÂ∫îÊï∞ÊçÆ
    if (result.value.response) {
      // Ê†ºÂºèÂåñHTTPÂìçÂ∫îÊï∞ÊçÆ
      responseContent.value = formatHttpData(result.value.response);
    } else {
      responseContent.value = '';
    }
  } else {
    requestContent.value = '';
    responseContent.value = '';
  }
};

// Ê†ºÂºèÂåñHTTPÊï∞ÊçÆ
const formatHttpData = (httpData: string): string => {
  if (!httpData) return '';
  
  // ÂÖàÂ§ÑÁêÜËΩ¨‰πâÂ≠óÁ¨¶
  let text = httpData
    .replace(/\\r\\n/g, '\r\n')
    .replace(/\\n/g, '\n')
    .replace(/\\r/g, '\r')
    .replace(/\\t/g, '\t');
  
  // Â∞ùËØïËß£ÊûêÂíåÊ†ºÂºèÂåñHTTPÊï∞ÊçÆ
  try {
    // ÂàÜÁ¶ªËØ∑Ê±Ç/ÂìçÂ∫îË°å„ÄÅÂ§¥ÈÉ®ÂíåÊ≠£Êñá
    const parts = text.split(/\r\n\r\n|\n\n/);
    
    if (parts.length >= 2) {
      const headers = parts[0];
      const body = parts.slice(1).join('\n\n');
      
      // Ê†ºÂºèÂåñÂ§¥ÈÉ®ÔºåÁ°Æ‰øùÊØè‰∏™Â§¥ÈÉ®Âú®Êñ∞Ë°å
      const formattedHeaders = headers
        .split(/\r\n|\n/)
        .map(line => line.trim())
        .join('\n');
      
      // Â∞ùËØïÊ†ºÂºèÂåñÊ≠£ÊñáÔºàÂ¶ÇÊûúÊòØJSONÔºâ
      let formattedBody = body;
      try {
        // Ê£ÄÊü•ÊòØÂê¶ÊòØJSON
        const contentTypeMatch = headers.match(/content-type:\s*(application\/json)/i);
        if (contentTypeMatch || (body.trim().startsWith('{') && body.trim().endsWith('}'))) {
          const jsonObj = JSON.parse(body.trim());
          formattedBody = JSON.stringify(jsonObj, null, 2);
        }
      } catch (e) {
        // Â¶ÇÊûú‰∏çÊòØÊúâÊïàÁöÑJSONÔºå‰øùÊåÅÂéüÊ†∑
        console.log('Body is not valid JSON, keeping as is');
      }
      
      // ÁªÑÂêàÊ†ºÂºèÂåñÂêéÁöÑÂ§¥ÈÉ®ÂíåÊ≠£Êñá
      return formattedHeaders + '\n\n' + formattedBody;
    }
  } catch (e) {
    console.error('Error formatting HTTP data:', e);
  }
  
  // Â¶ÇÊûúËß£ÊûêÂ§±Ë¥•ÔºåËøîÂõûÂéüÂßãÊñáÊú¨
  return text;
};

// Ê†πÊçÆÂÖ≥ÈîÆËØçÁ≠õÈÄâÊèí‰ª∂ÂàóË°®
const filteredPlugins = computed(() => {
  if (!searchKeyword.value) return plugins.value;
  
  const keyword = searchKeyword.value.toLowerCase();
  return plugins.value.filter(plugin => 
    plugin.name.toLowerCase().includes(keyword) || 
    plugin.description.toLowerCase().includes(keyword) ||
    plugin.rtype.toLowerCase().includes(keyword)
  );
});

// Ëé∑ÂèñÊØèÁßçÁ±ªÂûãÁöÑÊèí‰ª∂Êï∞Èáè
const getPluginCountByType = (type: string) => {
  return plugins.value.filter(plugin => plugin.rtype === type).length;
};

// Ëé∑ÂèñÊèí‰ª∂Á±ªÂûãÁöÑÁøªËØëÔºåËã•Êó†ÂåπÈÖçÂàôÊòæÁ§∫"ÂÖ∂ÂÆÉ"
const getPluginTypeTranslation = (type: string): string => {
  const translationKey = `vuln.pluginType.${type}`;
  const translation = t(translationKey);
  
  // Â¶ÇÊûúÁøªËØëÈîÆ‰∏çÂ≠òÂú®ÊàñËøîÂõû‰∫ÜÁ©∫ÂÄºÔºå‰ΩøÁî®"ÂÖ∂ÂÆÉ"Á±ªÂûãÁöÑÁøªËØë
  if (translation === translationKey) {
    return t('vuln.pluginType.other');
  }
  
  return translation;
};

// ÊûÑÂª∫Ê†ëÂΩ¢Êï∞ÊçÆÁªìÊûÑ
const pluginTreeData = computed(() => {
  const typeMap = new Map<string, VulnPlugin[]>();
  const searchResult = filteredPlugins.value;
  
  // ÊåâÁ±ªÂûãÂàÜÁªÑÊèí‰ª∂
  searchResult.forEach(plugin => {
    const type = plugin.rtype || 'other';
    if (!typeMap.has(type)) {
      typeMap.set(type, []);
    }
    typeMap.get(type)?.push(plugin);
  });
  
  // ÁîüÊàêÊ†ëÂΩ¢ÁªìÊûÑ
  const treeData: any[] = [];
  
  Array.from(typeMap.entries()).forEach(([type, pluginList]) => {
    // Â¶ÇÊûúËØ•Á±ªÂûãÊúâÊèí‰ª∂ÔºåÊ∑ªÂä†Á±ªÂûãËäÇÁÇπ
    if (pluginList.length > 0) {
      const keyword = searchKeyword.value.toLowerCase();
      const isTypeMatch = keyword && type.toLowerCase().includes(keyword);
      
      const typeNode = {
        key: type,
        title: getPluginTypeTranslation(type),
        selectable: false, // Á±ªÂûãËäÇÁÇπ‰∏çÂèØÈÄâÊã©
        isSearchMatch: isTypeMatch,
        children: pluginList.map(plugin => {
          // Âà§Êñ≠ÂêÑÁßçÂåπÈÖçÁ±ªÂûã
          const isNameMatch = keyword && plugin.name.toLowerCase().includes(keyword);
          const isDescMatch = keyword && plugin.description.toLowerCase().includes(keyword);
          
          return {
            key: String(plugin.id), // Á°Æ‰øùIDÊòØÂ≠óÁ¨¶‰∏≤
            title: plugin.name,
            isLeaf: true,
            severity: plugin.severity,
            // Â¶ÇÊûúÂú®ÊêúÁ¥¢Áä∂ÊÄÅ‰∏ãÔºåÊ†áËÆ∞ÂåπÈÖçÁöÑËäÇÁÇπ
            isSearchMatch: (isNameMatch || isDescMatch || isTypeMatch) && !!searchKeyword.value,
            // ËÆ∞ÂΩïÂåπÈÖçÂéüÂõ†ÔºåÁî®‰∫éÂèØËÉΩÁöÑUIÊèêÁ§∫
            matchReason: isNameMatch 
              ? 'name' 
              : isDescMatch 
                ? 'description' 
                : isTypeMatch 
                  ? 'type' 
                  : ''
          };
        })
      };
      treeData.push(typeNode);
    }
  });
  
  return treeData;
});

// Â§ÑÁêÜÊ†ëËäÇÁÇπÈÄâÊã©
const handleTreeSelect = (_selectedKeys: (string | number)[], info: any) => {
  const nodeData = info.node;
  
  // Âè™ÊúâÂè∂Â≠êËäÇÁÇπÊâçÂåÖÂê´Êèí‰ª∂
  if (nodeData.isLeaf) {
    selectedPluginId.value = String(nodeData.key);
    
    // Âú®Ê†ëËäÇÁÇπ‰∏≠Áõ¥Êé•ÂØªÊâæÂπ∂Ëé∑ÂèñÊèí‰ª∂
    const pluginId = selectedPluginId.value;
    const plugin = plugins.value.find(p => String(p.id) === pluginId);
    
    if (plugin) {
      handleSelectPlugin(plugin);
    } else {
      console.error('Êó†Ê≥ïÊâæÂà∞ÈÄâ‰∏≠ÁöÑÊèí‰ª∂:', pluginId);
    }
  }
};

// Ëé∑ÂèñÊâÄÊúâÊèí‰ª∂
const fetchPlugins = async () => {
  loading.value = true;
  try {
    plugins.value = await getAllPlugins();
    return true; // ËøîÂõû‰∏Ä‰∏™ÊàêÂäüÁä∂ÊÄÅ
  } catch (error) {
    Message.error(t('vuln.exploit.fetchError'));
    console.error('Error fetching plugins:', error);
    return false; // ËøîÂõû‰∏Ä‰∏™Â§±Ë¥•Áä∂ÊÄÅ
  } finally {
    loading.value = false;
  }
};

// ÈÄâÊã©Êèí‰ª∂
const handleSelectPlugin = (plugin: VulnPlugin) => {
  selectedPlugin.value = plugin;
  
  // ÈáçÁΩÆË°®ÂçïÊï∞ÊçÆÔºå‰ΩøÁî®Êèí‰ª∂ÈªòËÆ§ÂÄº
  formData.target = '';
  formData.proxy_url = '';
  
  // ÈáçÁΩÆÂä®ÊÄÅÂèÇÊï∞ - Èò≤Ê≠¢Âç°Ê≠ªÔºå‰ºòÂåñÂèÇÊï∞Â§ÑÁêÜ
  if (plugin.params && Array.isArray(plugin.params)) {
    // ÂÖàÊ∏ÖÈô§‰πãÂâçÁöÑÊâÄÊúâÂèÇÊï∞
    for (const key in formData) {
      if (key !== 'target') {
        delete formData[key];
      }
    }
    
    // Ê∑ªÂä†Êñ∞ÁöÑÂèÇÊï∞
    plugin.params.forEach((param: PluginParamDef) => {
      // ÂêåÊó∂Ê£ÄÊü•defaultÂíådefault_valueÂ±ûÊÄß
      if (param.default !== undefined) {
        formData[param.key] = param.default;
      } else if ((param as any).default_value !== undefined) { 
        // ‰ΩøÁî®Á±ªÂûãÊñ≠Ë®ÄËÆøÈóÆÂèØËÉΩÂ≠òÂú®ÁöÑdefault_valueÂ±ûÊÄß
        formData[param.key] = (param as any).default_value;
      } else {
        formData[param.key] = '';
      }
    });
  }
  
  // ÈáçÁΩÆÁªìÊûú
  result.value = null;
};

// Ëé∑ÂèñÊèí‰ª∂Âü∫Êú¨‰ø°ÊÅØ
const getPluginBasicInfo = () => {
  if (!selectedPlugin.value) return [];
  
  return [
    {
      label: t('vuln.plugin.type'),
      value: getPluginTypeTranslation(selectedPlugin.value.rtype)
    },
    {
      label: t('vuln.plugin.severity'),
      value: selectedPlugin.value.severity ? t(`vuln.severity.${selectedPlugin.value.severity}`) : ''
    },
    {
      label: t('vuln.plugin.author'),
      value: selectedPlugin.value.author
    },
    {
      label: t('vuln.plugin.version'),
      value: selectedPlugin.value.version
    },
    {
      label: t('vuln.plugin.references'),
      value: selectedPlugin.value.references ? selectedPlugin.value.references.join(', ') : ''
    }
  ];
};

// Ëé∑ÂèñÁªìÊûúÊï∞ÊçÆ‰ø°ÊÅØ
const getMainResultData = () => {
  if (!result.value || !result.value.data) return [];
  
  const data = result.value.data;
  const resultInfo: ExtendedDescData[] = [];
  const testResults: ExtendedDescData[] = []; // ‰∏ìÈó®Â≠òÂÇ®ÊµãËØïÁªìÊûú
  
  // ÈÄíÂΩíÂáΩÊï∞ÔºåÁî®‰∫éÊ†ºÂºèÂåñÂ§çÊùÇÊï∞ÊçÆÁ±ªÂûã
  const formatValue = (value: any): string => {
    if (value === null || value === undefined) {
      return '-';
    } else if (Array.isArray(value)) {
      if (value.length === 0) return '[]';
      return value.map(item => formatValue(item)).join(', ');
    } else if (typeof value === 'object') {
      return JSON.stringify(value, null, 2);
    } else {
      return String(value);
    }
  };
  
  // È¶ñÂÖàÂ§ÑÁêÜÊµãËØïÁªìÊûúÔºåÂÆÉ‰ª¨‰ºöÊòæÁ§∫Âú®ÊúÄ‰∏äÊñπ
  if (data.test_results && typeof data.test_results === 'object') {
    const label = t(`vuln.exploit.test_results`) !== `vuln.exploit.test_results` 
      ? t(`vuln.exploit.test_results`) 
      : 'Test Results';
    
    // Â∞Ütest_resultsÂØπË±°ÁöÑÊØè‰∏™ÈîÆÂÄºÂØπËΩ¨Êç¢‰∏∫ÂçïÁã¨ÁöÑÊèèËø∞È°πÔºå‰ΩøÁî®ÊâÅÂπ≥ÂåñÁ¨¶Âè∑
    Object.keys(data.test_results).forEach(testKey => {
      const testValue = data.test_results[testKey];
      const formattedValue = formatValue(testValue);
      
      // Ê£ÄÊü•ÊµãËØïÁªìÊûúÊòØÂê¶Ë°®ÊòéÊúâÈóÆÈ¢ò
      const hasIssue = typeof testValue === 'boolean' 
        ? testValue  // Â¶ÇÊûúÊòØÂ∏ÉÂ∞îÂÄºÔºåtrueË°®Á§∫ÊúâÈóÆÈ¢ò
        : typeof testValue === 'string' 
          ? testValue.toLowerCase().includes('default') || 
            testValue.toLowerCase().includes('vuln') ||
            testValue.toLowerCase().includes('detected')
          : false;
          
      // Ê†πÊçÆÊµãËØïÁªìÊûúËÆæÁΩÆ‰∏çÂêåÁöÑÂõæÊ†áÂíåÊ†∑Âºè
      const valueDisplay = hasIssue 
        ? `üõë ${formattedValue}` 
        : `‚úì ${formattedValue}`;
      
      testResults.push({
        label: `${label} - ${testKey}`,
        value: valueDisplay,
        risk: hasIssue
      });
    });
  }
  
  // ÈÅçÂéÜÊï∞ÊçÆÂØπË±°ÁöÑÊâÄÊúâÈîÆ
  Object.keys(data).forEach(key => {
    // Ë∑≥ËøáÂ∑≤Âú®HTTPËØ∑Ê±Ç/ÂìçÂ∫î‰∏≠ÊòæÁ§∫ÁöÑÊï∞ÊçÆ
    if (['http_request', 'http_response', 'http_status', 'http_url', 'http_method'].includes(key)) {
      return;
    }
    
    // Ë∑≥ËøáÁâπÊÆäÂ≠óÊÆµÔºåÂÆÉ‰ª¨‰ºöÂú®ÁâπÊÆäÈÉ®ÂàÜÊòæÁ§∫
    if (['risk_level', 'info', 'cve', 'references', 'test_results'].includes(key)) {
      return;
    }
    
    const value = data[key];
    const hasRisk = typeof value === 'string' && 
      (value.toLowerCase().includes('vulnerable') || 
       value.toLowerCase().includes('detected') ||
       value.toLowerCase().includes('default'));
    
    const label = t(`vuln.exploit.${key}`) !== `vuln.exploit.${key}` 
      ? t(`vuln.exploit.${key}`) 
      : key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');
    
    // ÊºèÊ¥ûÁ±ªÂûãÂä†ÂõæÊ†á(‰ΩøÁî®ÈÜíÁõÆÂõæÊ†á)
    if (key === 'type') {
      resultInfo.push({
        label,
        value: `üîç ${value}`,
        risk: hasRisk
      });
    } else {
      resultInfo.push({
        label,
        value: hasRisk ? `‚ö†Ô∏è ${formatValue(value)}` : formatValue(value),
        risk: hasRisk
      });
    }
  });
  
  // Â∞ÜÊµãËØïÁªìÊûúÊîæÂú®ÊúÄÂâçÈù¢
  return [...testResults, ...resultInfo];
};

const getSpecialResultData = () => {
  if (!result.value || !result.value.data) return [];
  
  const data = result.value.data;
  const specialFields: ExtendedDescData[] = []; // ÂçïÁã¨Â≠òÂÇ®ÁâπÊÆäÂ≠óÊÆµ
  
  // ÈÄíÂΩíÂáΩÊï∞ÔºåÁî®‰∫éÊ†ºÂºèÂåñÂ§çÊùÇÊï∞ÊçÆÁ±ªÂûã
  const formatValue = (value: any): string => {
    if (value === null || value === undefined) {
      return '-';
    } else if (Array.isArray(value)) {
      if (value.length === 0) return '[]';
      return value.map(item => formatValue(item)).join(', ');
    } else if (typeof value === 'object') {
      return JSON.stringify(value, null, 2);
    } else {
      return String(value);
    }
  };
  
  // Âè™Â§ÑÁêÜÁâπÊÆäÂ≠óÊÆµ (Ê≥®ÊÑè‰∏çÂÜçÂåÖÂê´test_results)
  ['risk_level', 'info', 'cve', 'references'].forEach(key => {
    if (!(key in data)) return;
    
    const value = data[key];
    const label = t(`vuln.exploit.${key}`) !== `vuln.exploit.${key}` 
      ? t(`vuln.exploit.${key}`) 
      : key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');
    
    // ÂØπÁâπÊÆäÂ≠óÊÆµËøõË°åÁÆÄÂçïÂ§ÑÁêÜÔºåÂπ∂ÊîæÂÖ•ÁâπÊÆäÂ≠óÊÆµÊï∞ÁªÑ (‰ΩøÁî®ÈÜíÁõÆÂõæÊ†á)
    if (key === 'risk_level') {
      const lowerLevel = String(value).toLowerCase();
      let displayValue = value;
      let icon = '';
      
      if (lowerLevel === 'high' || lowerLevel === 'È´ò') {
        icon = 'üî¥';
        displayValue = `${icon} ${value} (${t('vuln.risk.high')})`;
      } else if (lowerLevel === 'medium' || lowerLevel === '‰∏≠') {
        icon = 'üü†';
        displayValue = `${icon} ${value} (${t('vuln.risk.medium')})`;
      } else if (lowerLevel === 'low' || lowerLevel === '‰Ωé') {
        icon = 'üü°';
        displayValue = `${icon} ${value} (${t('vuln.risk.low')})`;
      }
      
      specialFields.push({
        label,
        value: displayValue,
        risk: lowerLevel === 'high' || lowerLevel === 'È´ò' || lowerLevel === 'medium' || lowerLevel === '‰∏≠'
      });
    } else if (key === 'info') {
      // ÊºèÊ¥û‰ø°ÊÅØ‰ΩøÁî®ÈÜíÁõÆÂõæÊ†á
      specialFields.push({
        label,
        value: `‚ÑπÔ∏è ${value}`,
        risk: false
      });
    } else if (key === 'cve' && Array.isArray(value)) {
      // CVEÂàóË°®‰ΩøÁî®ÈÜíÁõÆÂõæÊ†á
      const formattedValue = value.length > 0 
        ? `‚ö†Ô∏è ${value.join(', ')}` 
        : '-';
      specialFields.push({
        label,
        value: formattedValue,
        risk: value.length > 0
      });
    } else if (key === 'references' && Array.isArray(value)) {
      // ÂºïÁî®ÈìæÊé•‰ΩøÁî®ÈÜíÁõÆÂõæÊ†á
      const formattedValue = value.length > 0 
        ? `üîó ${value.join('\nüîó ')}` 
        : '-';
      specialFields.push({
        label,
        value: formattedValue,
        risk: false
      });
    }
  });
  
  return specialFields;
};

// Ëé∑ÂèñÈ£éÈô©Á∫ßÂà´ÁöÑÊ†áÁ≠æÈ¢úËâ≤
const getSeverityColor = (severity: SeverityLevel | undefined) => {
  if (!severity) return '';
  
  switch (severity) {
    case SeverityLevel.CRITICAL:
      return 'rgb(var(--danger-6))';
    case SeverityLevel.HIGH:
      return 'rgb(var(--orange-6))';
    case SeverityLevel.MEDIUM:
      return 'rgb(var(--warning-6))';
    case SeverityLevel.LOW:
      return 'rgb(var(--success-6))';
    case SeverityLevel.INFO:
      return 'rgb(var(--gray-6))';
    default:
      return '';
  }
};

// Ëé∑Âèñ‰∏•ÈáçÁ∫ßÂà´Ê†áÁ≠æ
const getSeverityLabel = (severity: SeverityLevel | undefined) => {
  if (!severity) return '';
  return t(`vuln.severity.${severity}`);
};

// Êñá‰ª∂‰∏ä‰º†Â§ÑÁêÜÂáΩÊï∞
const handleFileUpload = (options: any, paramKey: string): Record<string, any> => {
  const file = options.file;
  if (!file) return {};
  
  // ËØªÂèñÊñá‰ª∂ÂÜÖÂÆπ
  const reader = new FileReader();
  reader.onload = (e) => {
    if (e.target?.result) {
      // Â∞ÜÊñá‰ª∂ÂÜÖÂÆπÂíåÊñá‰ª∂Âêç‰øùÂ≠òÂà∞Ë°®ÂçïÊï∞ÊçÆ‰∏≠
      formData[paramKey] = {
        name: file.name,
        content: e.target.result
      };
      options.onSuccess && options.onSuccess();
    }
  };
  
  reader.onerror = (e) => {
    options.onError && options.onError(e);
  };
  
  // Ê†πÊçÆ‰∏çÂêåÁ±ªÂûãËØªÂèñÊñá‰ª∂
  if (file.type.startsWith('text/') || file.type === 'application/json') {
    reader.readAsText(file);
  } else {
    reader.readAsDataURL(file);
  }
  
  // ËøîÂõû‰∏Ä‰∏™Á©∫ÂØπË±°‰ª•Êª°Ë∂≥UploadRequestÁ±ªÂûãË¶ÅÊ±Ç
  return {};
};

// Ëé∑ÂèñÊñá‰ª∂ÂêçÂáΩÊï∞
const getFileName = (fileData: any): string => {
  if (!fileData || !fileData.name) return '';
  return fileData.name;
};

// ÊâßË°åÊºèÊ¥ûÂà©Áî®
const handleExploit = async () => {
  if (!selectedPlugin.value || !formData.target) {
    Message.error(t('vuln.exploit.targetRequired'));
    return;
  }
  
  exploiting.value = true;
  try {
    // ÊûÑÈÄ†Ëá™ÂÆö‰πâÂèÇÊï∞ÂØπË±°
    const customParams: Record<string, any> = {};
    if (selectedPlugin.value.params && Array.isArray(selectedPlugin.value.params)) {
      for (const param of selectedPlugin.value.params) {
        if (formData[param.key] !== undefined) {
          customParams[param.key] = formData[param.key];
        }
      }
    }
    
    // Ê∑ªÂä†‰ª£ÁêÜURLÂèÇÊï∞
    if (formData.proxy_url) {
      customParams.proxy_url = formData.proxy_url;
    }
    
    // Ë∞ÉËØïËæìÂá∫
    console.log('ÂèëÈÄÅÂà∞ÂêéÁ´ØÁöÑÂèÇÊï∞:', {
      plugin_name: selectedPlugin.value.name,
      plugin_type: selectedPlugin.value.rtype,
      target: formData.target,
      custom_params: customParams
    });
    
    let exploitResult;
    exploitResult = await invoke('execute_rhai_plugin', {
        params: {
          plugin_name: selectedPlugin.value.name,
          plugin_type: selectedPlugin.value.rtype,
          target: formData.target,
          custom_params: customParams,
          include_http_data: true // ÊòæÂºèËØ∑Ê±ÇÂåÖÂê´HTTPÊï∞ÊçÆ
        }
      }) as ExploitResult;
    
    result.value = exploitResult;
    
    // Á°Æ‰øùËØ∑Ê±ÇÂìçÂ∫îÊï∞ÊçÆÂ≠òÂú®ÔºåÂ¶ÇÊûúÂêéÁ´ØÊ≤°ÊúâÊèê‰æõÔºåÂàôÊòæÁ§∫Âç†‰ΩçÊñáÊú¨
    if (!result.value.request) {
      result.value.request = t('vuln.exploit.noRequestData');
    }
    
    if (!result.value.response) {
      result.value.response = t('vuln.exploit.noResponseData');
    }
    
    // ÂàÜÁ¶ªÊâßË°åÊàêÂäüÂíåÊºèÊ¥ûÊ£ÄÊµãÁªìÊûú
    // Âè™Ë¶ÅËÉΩÂ§üËé∑ÂèñÂà∞ÁªìÊûúÔºåÂ∞±ËÆ§‰∏∫ÊâßË°åÊàêÂäü
    if (result.value !== null) {
      // ‰ΩøÁî®ÂÖ®Â±ÄÈÄöÁü•Êõø‰ª£Ê∂àÊÅØÊèêÁ§∫
      Notification.success({
        title: t('vuln.exploit.executeSuccess'),
        content: selectedPlugin.value.name,
        position: 'topRight',
        duration: 3000
      });
      
      // È¢ùÂ§ñÊòæÁ§∫ÊºèÊ¥ûÊ£ÄÊµãÁªìÊûú
      if (result.value.success) {
        // ‰ΩøÁî®ÈÄöÁü•ÊèêÈÜíÊ°ÜÊòæÁ§∫ÊºèÊ¥ûÊ£ÄÊµãÁªìÊûú
        Notification.warning({
          title: t('vuln.exploit.vulnerableFound'),
          content: selectedPlugin.value.name,
          position: 'topRight',
          duration: 5000
        });
      } else {
        // ÊèêÁ§∫Êú™ÂèëÁé∞ÊºèÊ¥û
        Notification.info({
          title: t('vuln.exploit.notVulnerable'),
          content: selectedPlugin.value.name,
          position: 'topRight',
          duration: 3000
        });
      }
    } else {
      Notification.error({
        title: t('vuln.exploit.executeFailed'),
        content: '',
        position: 'topRight',
        duration: 3000
      });
    }
  } catch (error) {
    Notification.error({
      title: t('vuln.exploit.executeError'),
      content: String(error),
      position: 'topRight',
      duration: 5000
    });
    console.error('Error executing exploit:', error);
  } finally {
    exploiting.value = false;
  }
};

// Â§ÑÁêÜÊêúÁ¥¢ËæìÂÖ•ÂèòÂåñ
const onSearchInput = () => {
  // Â¶ÇÊûúÊ∏ÖÁ©∫‰∫ÜÊêúÁ¥¢Ê°ÜÔºåÁõ¥Êé•Ëß¶ÂèëÊêúÁ¥¢
  if (!searchKeyword.value) {
    onSearchSubmit('');
  }
};

// ÂÆö‰πâ‰∏Ä‰∏™ÂÖ®Â±ÄÊêúÁ¥¢Êèê‰∫§ÂáΩÊï∞Ôºå‰∏éËæìÂÖ•Ê°ÜÁõ¥Êé•ÁªëÂÆö
const onSearchSubmit = (value: string) => {
  console.log('ÁÇπÂáªÊêúÁ¥¢ÊåâÈíÆ:', value);
  
  // ÊâßË°åÊêúÁ¥¢
  if (value) {
    // ÊúâÊêúÁ¥¢ËØçÊó∂ÔºåÂÖàÁ°ÆÂÆöÂì™‰∫õËäÇÁÇπÂåÖÂê´ÁªìÊûú
    const typesWithResults = Array.from(new Set(
      plugins.value.filter(plugin => 
        plugin.name.toLowerCase().includes(value.toLowerCase()) || 
        plugin.description.toLowerCase().includes(value.toLowerCase()) ||
        plugin.rtype.toLowerCase().includes(value.toLowerCase())
      ).map(plugin => plugin.rtype || 'other')
    ));
    
    console.log('ÈúÄË¶ÅÂ±ïÂºÄÁöÑËäÇÁÇπ:', typesWithResults);
    
    // Âº∫Âà∂Êõ¥Êñ∞Â±ïÂºÄÁä∂ÊÄÅÔºåÂè™Â±ïÂºÄÂåÖÂê´ÊêúÁ¥¢ÁªìÊûúÁöÑËäÇÁÇπ
    expandedKeys.value = [...typesWithResults];
    
    // Ëá™Âä®ÈÄâÊã©Á¨¨‰∏Ä‰∏™ÂåπÈÖçÁöÑÊèí‰ª∂
    const filtered = plugins.value.filter(plugin => 
      plugin.name.toLowerCase().includes(value.toLowerCase()) || 
      plugin.description.toLowerCase().includes(value.toLowerCase()) ||
      plugin.rtype.toLowerCase().includes(value.toLowerCase())
    );
    
    if (filtered.length > 0) {
      selectedPluginId.value = String(filtered[0].id);
      handleSelectPlugin(filtered[0]);
    }
  } else {
    // ÊêúÁ¥¢ËØç‰∏∫Á©∫Êó∂ÔºåÊÅ¢Â§çÈªòËÆ§Áä∂ÊÄÅÔºà‰∏çÂ±ïÂºÄ‰ªª‰ΩïËäÇÁÇπÔºâ
    expandedKeys.value = [];
  }
};

// Âú®ÁªÑ‰ª∂ÊåÇËΩΩÊó∂Ëé∑ÂèñÊèí‰ª∂ÂàóË°®ÂíåÂàùÂßãÂåñÊ†ëÁä∂ÊÄÅ
onMounted(() => {
  // Ëé∑ÂèñÊèí‰ª∂ÂàóË°®
  fetchPlugins().then(() => {
    // Ëé∑ÂèñÂÆåÊàêÂêéÔºåÈªòËÆ§‰∏çÂ±ïÂºÄ‰ªª‰ΩïËäÇÁÇπ
    nextTick(() => {
      // ÈªòËÆ§‰∏çÂ±ïÂºÄ‰ªª‰ΩïËäÇÁÇπ
      expandedKeys.value = [];
      console.log('ÂàùÂßãÁä∂ÊÄÅÔºå‰∏çÂ±ïÂºÄ‰ªª‰ΩïËäÇÁÇπ');
    });
  });
});

// ‰ºòÂåñhasRiskButNotExploitableËÆ°ÁÆóÂ±ûÊÄßÔºåÊõ¥Á≤æÁ°ÆÂú∞Ê£ÄÊµãÊµãËØïÁªìÊûú‰∏≠ÁöÑÈ£éÈô©
const hasRiskButNotExploitable = computed(() => {
  if (!result.value || !result.value.data) return false;
  
  // Ê£ÄÊü•ÁªìÊûú‰∏≠ÊòØÂê¶ÂåÖÂê´È£éÈô©‰ø°ÊÅØ‰ΩÜÊú™ÊàêÂäüÂà©Áî®
  const data = result.value.data;
  
  // Ê£ÄÊü•ÊòØÂê¶Êúâ‰ªª‰ΩïÊµãËØïÁªìÊûúË°®ÊòéÂ≠òÂú®ÈóÆÈ¢ò
  let hasTestResultIssues = false;
  if (data.test_results && typeof data.test_results === 'object') {
    hasTestResultIssues = Object.values(data.test_results).some(val => {
      if (typeof val === 'boolean') return val;
      if (typeof val === 'string') {
        const lowerVal = val.toLowerCase();
        return lowerVal.includes('default') || 
               lowerVal.includes('vuln') ||
               lowerVal.includes('detected');
      }
      return false;
    });
  }
  
  return !result.value.success && 
         (hasTestResultIssues || 
          data.risk_level || 
          (data.info && data.info.toLowerCase().includes('default')) ||
          (Array.isArray(data.cve) && data.cve.length > 0));
});

// Add computed property for virtual list height
const virtualListHeight = computed(() => {
  // Default height if we can't calculate dynamically
  return 550;
});

// Add component prop defaultization
const getSelectedPluginId = computed(() => {
  return selectedPluginId.value ? [selectedPluginId.value] : [];
});

// Fix the computed properties
const mainResultData = computed(() => {
  if (!result.value || !result.value.data) return [] as ExtendedDescData[];
  return getMainResultData();
});

const specialResultData = computed(() => {
  if (!result.value || !result.value.data) return [] as ExtendedDescData[];
  return getSpecialResultData();
});

// Â§ÑÁêÜÊ†ëËäÇÁÇπÂ±ïÂºÄ
const handleTreeExpand = (expandKeys: (string | number)[], _data: any) => {
  console.log('Ê†ëËäÇÁÇπÂ±ïÂºÄÁä∂ÊÄÅÂèòÂåñ:', expandKeys);
};

// ÁõëÂê¨expandedKeysÂèòÂåñ
watch(expandedKeys, (newVal) => {
  console.log('expandedKeysÂèòÂåñ:', newVal);
}, { deep: true });

// ÁõëÂê¨filteredPluginsÂèòÂåñ
watch(() => filteredPlugins.value.length, (newCount) => {
  console.log('ËøáÊª§ÂêéÁöÑÊèí‰ª∂Êï∞ÈáèÂèòÂåñ:', newCount);
  if (searchKeyword.value) {
    nextTick(() => {
      // Âº∫Âà∂Êõ¥Êñ∞Â±ïÂºÄÁä∂ÊÄÅ
      const typesWithResults = Array.from(new Set(
        filteredPlugins.value.map(plugin => plugin.rtype || 'other')
      ));
      console.log('Êèí‰ª∂Êï∞ÈáèÂèòÂåñÂêéÊõ¥Êñ∞Â±ïÂºÄÁä∂ÊÄÅ:', typesWithResults);
      expandedKeys.value = typesWithResults;
    });
  }
});

// ÂΩìÈÄâÊã©‰∫ÜÂëΩ‰ª§ÊâßË°åÁ±ªÊºèÊ¥ûÔºåÊòæÁ§∫ÂëΩ‰ª§Ë°åShellÈÄâÈ°πÂç°
const isCommandExecution = computed(() => {
  if (!selectedPlugin.value) return false;
  return selectedPlugin.value.name.toLowerCase().includes('ÂëΩ‰ª§') || 
         selectedPlugin.value.name.toLowerCase().includes('command') ||
         selectedPlugin.value.description.toLowerCase().includes('ÂëΩ‰ª§ÊâßË°å') ||
         selectedPlugin.value.description.toLowerCase().includes('command injection') ||
         selectedPlugin.value.description.toLowerCase().includes('rce');
});

// Ê∑ªÂä†ÂëΩ‰ª§ÊâßË°åÂ§ÑÁêÜÊñπÊ≥ï
const handleCommandExecuted = (data: {command: string, output: string, success: boolean}) => {
  console.log('Command executed:', data);
  // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†ÂØπÂëΩ‰ª§ÊâßË°åÁªìÊûúÁöÑÂ§ÑÁêÜÈÄªËæë
};

// Ëé∑Âèñcmd_paramÂèÇÊï∞ÁöÑkey
const getCmdParamKey = () => {
  console.log("selectedPlugin.value: " , selectedPlugin.value)
  if (!selectedPlugin.value) return '';
  const cmdParamDef = selectedPlugin.value.params.find(p => 
    p.key === 'cmd_param' || 
    p.name.includes('ÂëΩ‰ª§ÂèÇÊï∞') || 
    p.name.includes('Command Parameter'));
  
  if (!cmdParamDef) return '';
  
  // ËøîÂõûËæìÂÖ•Ê°Ü‰∏≠ÁöÑÂÄºÔºåËÄå‰∏çÊòØÈîÆÂêç
  const paramValue = formData[cmdParamDef.key];
  console.log("ÂëΩ‰ª§ÂèÇÊï∞ÁöÑÂÄº: ", paramValue);
  return paramValue || '';
};

// ÁõëÂê¨ÊöóÈªëÊ®°ÂºèÂèòÂåñÔºåÂº∫Âà∂ÈáçÊñ∞Ê∏≤Êüì
watch(() => isDarkMode.value, () => {
  // ‰ΩøÁî®nextTickÁ°Æ‰øùDOMÂ∑≤Êõ¥Êñ∞
  nextTick(() => {
    // Ëß¶ÂèëÈáçÊñ∞Ê∏≤Êüì
    if (requestContent.value) {
      const temp = requestContent.value;
      requestContent.value = '';
      nextTick(() => {
        requestContent.value = temp;
      });
    }
    
    if (responseContent.value) {
      const temp = responseContent.value;
      responseContent.value = '';
      nextTick(() => {
        responseContent.value = temp;
      });
    }
  });
});
</script>

<style lang="less" scoped>
.vuln-exploit-container {
  padding: 0;
  
  .general-card {
    margin-bottom: 16px;
  }
  
  .inner-card {
    height: 100%;
    
    :deep(.arco-card-body) {
      padding: 8px;
    }
  }
  
  .plugin-search {
    margin-bottom: 6px;

    :deep(.arco-input-wrapper) {
      padding: 1px 4px;
    }
    
    :deep(.arco-input-group-wrapper) {
      padding-bottom: 1px;
    }
  }
  
  .plugin-actions {
    display: flex;
    justify-content: flex-end;
    margin-top: 4px;
  }
  
  .plugin-list {
    height: calc(100vh - 210px);
    overflow-y: auto;
    
    :deep(.arco-tree) {
      // Condense the tree nodes
      .arco-tree-node {
        padding: 4px 0;
        
        &-selected {
          background-color: rgba(var(--primary-1), 0.5);
        }
      }
      
      // Reduce the indent space
      .arco-tree-node-indent {
        &-unit {
          width: 16px; // Default is 20px
        }
      }
      
      // Make the expand icon smaller
      .arco-tree-node-expand-icon {
        font-size: 12px;
      }
    }
  }
  
  .tree-node {
    display: flex;
    align-items: center;
    width: 100%;
    
    .plugin-tree-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      
      .plugin-name-text {
        display: inline-block;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 75%; // Increased from 70%
        font-size: 12px; // Slightly smaller font
        
        &.search-match {
          font-weight: bold;
          color: var(--color-primary-6);
          background-color: rgba(var(--primary-1), 0.3);
          border-radius: 2px;
          padding: 0 2px;
        }
      }
    }
    
    strong {
      font-size: 13px; // Make category titles slightly larger for contrast
    }
    
    .plugin-count {
      margin-left: 4px;
      font-size: 11px; // Slightly smaller than default
      color: #999;
    }
  }
  
  .plugin-detail {
    &-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    &-title {
      font-size: 16px;
      font-weight: 600;
      margin-right: 8px;
      display: flex;
      align-items: center;
      
      .title-tag {
        margin-left: 8px;
      }
    }
  }

  .compact-heading {
    font-size: 14px;
    margin: 8px 0;
    font-weight: 500;
  }
  
  .compact-card {
    :deep(.arco-card-header) {
      padding: 8px 12px;
      min-height: auto;
    }
    
    :deep(.arco-card-body) {
      padding: 10px 12px;
    }
  }
  
  .form-item-label {
    font-weight: 500;
    margin-bottom: 4px;
  }
  
  .result-card {
    margin-bottom: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    border-radius: 6px;
    transition: box-shadow 0.3s, transform 0.2s;
    
    &:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
      transform: translateY(-1px);
    }
  }
  
  .result-card-title {
    display: flex;
    align-items: center;
    gap: 8px;
    
    .result-icon {
      &.success {
        color: rgb(var(--success-6));
      }
      
      &.warning {
        color: rgb(var(--warning-6));
      }
      
      &.info {
        color: rgb(var(--gray-6));
      }
    }
  }
  
  .result-data {
    margin-bottom: 16px;
    
    .data-item {
      display: flex;
      margin-bottom: 15px;
      align-items: flex-start;
      padding: 1px 5px;
      border-radius: 4px;
      transition: all 0.2s ease;
      
      &:hover {
        background-color: var(--color-fill-2);
      }
      
      &.risk-item {
        background-color: rgba(var(--warning-1), 0.5);
        border-left: 3px solid var(--color-warning-6);
        
        &:hover {
          background-color: rgba(var(--warning-2), 0.6);
        }
      }
      
      &-label {
        width: 250px;
        color: var(--color-text-2);
        font-size: 13px;
        flex-shrink: 0;
        padding-top: 1px;
        font-weight: 500;
        padding-right: 8px;
      }
      
      &-value {
        flex: 1;
        word-break: break-word;
        
        &.risk-value {
          color: var(--color-danger-6);
          font-weight: 500;
        }
        
        &.test-result-warning {
          color: var(--color-warning-6);
          font-weight: 500;
        }
      }
    }
  }
  
  .http-data {
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    background-color: #f5f5f5;
    padding: 12px;
    border-radius: 4px;
    overflow: auto;
    max-height: 400px;
    white-space: pre;
    font-size: 13px;
    line-height: 1.5;
    tab-size: 4;
    -moz-tab-size: 4;
    -o-tab-size: 4;
    
    code {
      display: block;
      width: 100%;
      overflow-wrap: normal;
      word-break: keep-all;
      word-wrap: normal;
      overflow-x: auto;
      color: #333;
    }
  }
  
  .code-container {
    border: 1px solid #e4e7ed;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 10px;
    background-color: #fafafa;
    position: relative;
    height: 400px;
    
    :deep(.cm-editor) {
      height: 100%;
      font-size: 13px;
    }
    
    :deep(.cm-gutters) {
      background-color: #f5f5f5;
      border-right: 1px solid #e4e7ed;
    }
    
    :deep(.cm-activeLineGutter) {
      background-color: #e8f2ff;
    }
    
    :deep(.cm-activeLine) {
      background-color: #e8f2ff;
    }
    
    :deep(.cm-content) {
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    }
    
    &.dark-mode {
      background-color: #1e1e1e;
      border-color: #333;
      
      :deep(.cm-editor) {
        background-color: #1e1e1e;
      }
      
      :deep(.cm-gutters) {
        background-color: #262626;
        border-right: 1px solid #333;
      }
      
      :deep(.cm-activeLineGutter) {
        background-color: #333;
      }
      
      :deep(.cm-activeLine) {
        background-color: #333;
      }
      
      :deep(.cm-content) {
        color: #d4d4d4;
      }
    }
  }

  .additional-info-section {
    margin-top: 16px;
    border-radius: 4px;
    overflow: hidden;
    
    :deep(.arco-collapse-item-header) {
      font-size: 13px;
      font-weight: 500;
      color: var(--color-text-2);
      background-color: var(--color-fill-2);
      padding: 8px 12px;
    }
    
    :deep(.arco-collapse-content-wrapper) {
      background-color: var(--color-neutral-1);
    }
    
    :deep(.arco-collapse-content-box) {
      padding: 12px;
    }
  }

  // Make the tags more compact in the plugin tree
  :deep(.arco-tag.arco-tag-size-small) {
    padding: 0 4px;
    margin-left: 4px;
    font-size: 10px;
    line-height: 16px;
  }

  :deep(.arco-tree-node-title) {
    padding: 0 4px;
  }

  :deep(.arco-tooltip) {
    .arco-trigger-popup {
      transition-delay: 0s;
    }
  }

  .category-header {
    display: flex;
    align-items: center;
    width: 100%;
    padding: 1px 0;
    
    strong {
      font-size: 13px;
      color: #555;
      
      &.search-match {
        color: var(--color-primary-6);
        background-color: rgba(var(--primary-1), 0.2);
        border-radius: 2px;
        padding: 0 2px;
      }
    }
  }



  // Add better spacing for form buttons
  :deep(.arco-form-item) {
    margin-bottom: 12px;
    
    &:last-child {
      margin-bottom: 0;
      margin-top: 16px;
    }
  }

  // Improve card title with tag styling
  .card-title-with-tag {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    
    .arco-tag {
      margin-left: 0;
    }
  }

  // Improve detail section spacing and borders
  .detail-section {
    margin-bottom: 16px;
    padding-bottom: 4px;
    
    &:not(:last-child) {
      border-bottom: 1px solid var(--color-neutral-3);
    }
    
    &:last-child {
      margin-bottom: 0;
    }
  }

  // Improve form layout
  :deep(.arco-form) {
    .arco-row {
      margin-bottom: -4px;
    }
    
    .arco-form-item-content {
      min-height: auto;
    }
    
    .arco-form-item-label-col {
      padding-bottom: 4px;
    }
    
    .arco-form-item-wrapper {
      margin-bottom: 8px;
    }
  }

  // Style the target and advanced options sections more distinctly
  .form-item-target {
    margin-bottom: 16px;
  }

  :deep(.arco-input-wrapper) {
    padding: 0 8px;
  }

  :deep(.arco-btn) {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
  }

  .risk-high {
    color: var(--color-danger-6);
    font-weight: 500;
  }

  .risk-medium {
    color: var(--color-warning-6);
    font-weight: 500;
  }

  .risk-low {
    color: var(--color-success-6);
    font-weight: 500;
  }

  .result-section {
    .result-card {
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      
      :deep(.arco-card-header) {
        padding: 8px 12px;
        border-bottom: 1px solid var(--color-border-2);
      }
      
      :deep(.arco-card-body) {
        padding: 12px;
      }
    }
    
    .result-card-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      font-size: 14px;
      
      .result-icon {
        font-size: 16px;
        
        &.success {
          color: var(--color-danger-6);
          animation: pulse 1.5s infinite;
        }
        
        &.warning {
          color: var(--color-warning-6);
          animation: pulse 2s infinite;
        }
        
        &.info {
          color: var(--color-neutral-6);
        }
      }
    }
  }

  @keyframes pulse {
    0% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
    100% {
      opacity: 1;
    }
  }

  // CSS for the plugin dialog
  .add-plugin-dialog {
    .script-editor-container {
      border: 1px solid var(--color-border-2);
      border-radius: 4px;
      overflow: hidden;
      
      :deep(.arco-textarea-wrapper) {
        padding: 4px;
        font-family: monospace;
        
        .arco-textarea {
          font-family: monospace;
          line-height: 1.5;
        }
      }
    }
    
    .script-editor-toolbar {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 4px;
    }
    
    .validation-error {
      color: var(--color-danger-6);
      margin-top: 8px;
      padding: 8px;
      background-color: var(--color-danger-1);
      border-radius: 4px;
      font-size: 13px;
    }
    
    .parameters-list {
      margin-bottom: 16px;
      
      :deep(.arco-table-th) {
        background-color: var(--color-fill-2);
        font-weight: 500;
        padding: 6px 8px;
      }
      
      :deep(.arco-table-td) {
        padding: 6px 8px;
      }
    }
  }
}
</style>